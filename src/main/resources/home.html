<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BudgetApp Home</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
    <div class="logo">CashClimb</div>
    <nav>
        <ul class="nav-items">
            <li class="profile-link-container">
                <a href="profile.html">
                    <img id="navProfileImage" class="nav-profile-img" alt="Profile" />
                </a>
                <a href="profile.html" class="active">Profile</a>
            </li>
        </ul>
    </nav>
</header>

<button class="drawer-toggle" onclick="toggleDrawer()">â˜°</button>
<nav class="drawer" id="sideDrawer">
    <ul>
        <li><a href="home.html">Dashboard</a></li>
        <li><a href="assetsLiabilities.html">Assets &amp; Liabilities</a></li>
        <li><a href="bills.html">Bills Page</a></li>
        <li><a href="budget.html">Budget</a></li>
        <li><a href="chat.html">Chat</a></li>
        <li><a href="crypto.html">Crypto</a></li>
        <li><a href="currency.html">Currency</a></li>
        <li><a href="expenses.html">Expenses</a></li>
        <li><a href="income.html">Income</a></li>
        <li><a href="leaderboard.html">Leaderboard</a></li>
        <li><a href="loanCalculator.html">Loan Calculator</a></li>
<!--        <li><a href="netWorth.html">Net Worth</a></li>-->
        <li><a href="tips.html">Tips</a></li>
        <li><a href="savedTips.html">Saved Tips</a></li>
        <li><a href="stocks.html">Stocks</a></li>
        <li><a href="tax.html">Tax</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="settings.html">Settings</a></li>
        <li><a href="/logout">Logout</a></li>
    </ul>
</nav>

<main>
    <section class="hero">
        <div class="hero-content">
            <h1>Dashboard</h1>
            <p>Your financial overview</p>
        </div>
    </section>

    <div class="dashboard">
        <div class="card" id="netWorthCard">
            <h2>Net Worth</h2>
            <p id="netWorthValue" style="font-weight: bold; font-size: 1.2em;"></p>
            <p id="assetsValue"></p>
            <p id="liabilitiesValue"></p>
        </div>
        <div class="card" id="taxCard">
            <h2>Taxes</h2>
            <p id="totalTaxesDisplay" style="font-weight: bold; font-size: 1.2em;"></p>
            <div id="taxesPieChart"></div>
        </div>
        <div class="card chart-section">
            <h2>Assets Breakdown</h2>
            <div id="assetsPieChart"></div>
        </div>
        <div class="card chart-section">
            <h2>Liabilities Breakdown</h2>
            <div id="liabilitiesPieChart"></div>
        </div>
        <div class="card" id="incomeByTimeCard">
            <h2>Income by Time Period</h2>
            <label for="incomeTimeSelect">Select Period:</label>
            <select id="incomeTimeSelect">
                <option value="year">Entire Year</option>
                <option value="0">January</option>
                <option value="1">February</option>
                <option value="2">March</option>
                <option value="3">April</option>
                <option value="4">May</option>
                <option value="5">June</option>
                <option value="6">July</option>
                <option value="7">August</option>
                <option value="8">September</option>
                <option value="9">October</option>
                <option value="10">November</option>
                <option value="11">December</option>
            </select>
            <p id="incomeSummaryDisplay" style="margin-top: 10px; font-weight: bold;"></p>
            <div id="incomeTimePieChart"></div>
        </div>
        <div class="card" id="incomeBarCard">
            <h2>Income Breakdown Bar Chart</h2>
            <div id="incomeTimeBarChart"></div>
        </div>
        <div class="card" id="expensesSummaryCard">
            <h2>Expenses Summary</h2>
            <label for="expensesMonthSelect">Select Month:</label>
            <select id="expensesMonthSelect">
                <option value="all">All</option>
                <option value="0">January</option>
                <option value="1">February</option>
                <option value="2">March</option>
                <option value="3">April</option>
                <option value="4">May</option>
                <option value="5">June</option>
                <option value="6">July</option>
                <option value="7">August</option>
                <option value="8">September</option>
                <option value="9">October</option>
                <option value="10">November</option>
                <option value="11">December</option>
            </select>
            <p id="expensesSummaryDisplay" style="margin-top: 10px; font-weight: bold;"></p>
            <div id="expensesTimePieChart"></div>
        </div>
        <div class="card" id="expensesBarCard">
            <h2>Expenses Bar Graph</h2>
            <label for="expensesBarMonthSelect">Select Month:</label>
            <select id="expensesBarMonthSelect">
                <option value="all">All</option>
                <option value="0">January</option>
                <option value="1">February</option>
                <option value="2">March</option>
                <option value="3">April</option>
                <option value="4">May</option>
                <option value="5">June</option>
                <option value="6">July</option>
                <option value="7">August</option>
                <option value="8">September</option>
                <option value="9">October</option>
                <option value="10">November</option>
                <option value="11">December</option>
            </select>
            <div id="expensesTimeBarChart"></div>
        </div>
    </div>
</main>

<script>
    function toggleDrawer() {
        document.getElementById('sideDrawer').classList.toggle('collapsed');
    }
    function getThemePreference(name) {
        const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return m ? m[2] : null;
    }

    window.addEventListener('pageshow', e => { if (e.persisted) location.reload(); });

    // window.addEventListener('DOMContentLoaded', () => {
    //     const theme = getThemePreference('theme');
    //     if (theme) document.body.classList.add(theme + '-mode');
    // });

    // window.addEventListener('DOMContentLoaded', () => {
    //     const navImg = document.getElementById('navProfileImage');
    //     fetch('/api/profile', {
    //         method: 'GET',
    //         credentials: 'include',
    //         headers: { 'Content-Type': 'application/json' }
    //     })
    //         .then(res => {
    //             if (!res.ok) throw new Error();
    //             return res.json();
    //         })
    //         .then(data => {
    //             const img = data.fields?.profileImage?.stringValue;
    //             if (img) navImg.src = img;
    //             else throw new Error();
    //         })
    //         .catch(() => {
    //             navImg.src = 'default-avatar.png';
    //         });
    // });

    // document.addEventListener('DOMContentLoaded', () => {
    //     const getInt = f => f?.integerValue ? parseInt(f.integerValue, 10)
    //         : f?.doubleValue ? Math.floor(parseFloat(f.doubleValue))
    //             : 0;
    //     const getArr = a => a?.arrayValue?.values || [];
    //
    //     fetch('/api/getData', {
    //         credentials: 'include'
    //     })
    //         .then(res => {
    //             if (!res.ok) {
    //                 console.error(`getData failed with status ${res.status}`);
    //                 return {};
    //             }
    //             return res.json();
    //         })
    //         .then(data => {
    //             const fields = data.fields || {};
    //             document.getElementById('netWorthDisplay').textContent =
    //                 '$' + getInt(fields.netWorth);
    //             document.getElementById('totalIncomeDisplay').textContent =
    //                 '$' + getInt(fields.totalIncome);
    //             document.getElementById('totalExpensesDisplay').textContent =
    //                 '$' + getInt(fields.totalExpenses);
    //             document.getElementById('billRemindersDisplay').innerHTML =
    //                 '<h1>' + getInt(fields.billsDue) + '</h1>';
    //
    //             let mExp = getArr(fields.monthlyExpenses).map(getInt);
    //             if (mExp.length < 12) mExp = Array(12).fill(0);
    //             buildBarChart(mExp);
    //             buildPieChartExpenses(mExp);
    //
    //             let mInc = getArr(fields.monthlyIncomes).map(getInt);
    //             if (mInc.length < 12) mInc = Array(12).fill(0);
    //             buildPieChartIncome(mInc);
    //         })
    //         .catch(e => console.error('Error fetching dashboard data:', e));
    // });

    function buildBarChart(data) {
        const svgNS = 'http://www.w3.org/2000/svg';
        const c = document.getElementById('chartContainer'),
            w = Math.max(500, c.clientWidth), h = 300, bw = w / data.length;
        const max = Math.max(...data, 1);
        const svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
        data.forEach((v,i) => {
            const ph = v / max * (h - 40),
                x = i * bw, y = h - ph;
            const r = document.createElementNS(svgNS,'rect');
            r.setAttribute('x', x);
            r.setAttribute('y', y);
            r.setAttribute('width', bw - 4);
            r.setAttribute('height', ph);
            r.setAttribute('fill', '#FF8C00');
            svg.appendChild(r);
            const t = document.createElementNS(svgNS,'text');
            t.setAttribute('x', x + (bw-4)/2);
            t.setAttribute('y', h - 5);
            t.setAttribute('fill', '#000');
            t.setAttribute('font-size','10');
            t.setAttribute('text-anchor','middle');
            t.textContent = i+1;
            svg.appendChild(t);
        });
        c.innerHTML = '';
        c.appendChild(svg);
    }

    function buildPieChartExpenses(data) {
        const svgNS = 'http://www.w3.org/2000/svg',
            cont = document.getElementById('expensesPieChart'),
            total = data.reduce((a,b)=>a+b,0);
        cont.innerHTML = '';
        if (total<=0) {
            cont.innerHTML = "<p style='padding:10px;text-align:center;'>No expense data</p>";
            return;
        }
        const size = 200, cx = size/2, cy = size/2, r = cx - 10;
        const svg = document.createElementNS(svgNS,'svg');
        svg.setAttribute('width',size);
        svg.setAttribute('height',size);
        const quarters = [0,0,0,0];
        data.forEach((v,i)=> quarters[Math.floor(i/3)] += v);
        const labels = ['Q1','Q2','Q3','Q4'],
            colors = ['#FF8C00','#FF4500','#1E90FF','#32CD32'];
        let start = 0, sum = quarters.reduce((a,b)=>a+b,0);
        quarters.forEach((v,i) => {
            if (!v) return;
            const angle = v/sum * 2*Math.PI,
                end = start + angle,
                x1 = cx + r*Math.cos(start),
                y1 = cy + r*Math.sin(start),
                x2 = cx + r*Math.cos(end),
                y2 = cy + r*Math.sin(end),
                large = angle>Math.PI?1:0,
                d = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z`;
            const p = document.createElementNS(svgNS,'path');
            p.setAttribute('d', d);
            p.setAttribute('fill', colors[i]);
            svg.appendChild(p);
            const mid = start + angle/2,
                lx = cx + (r/2)*Math.cos(mid),
                ly = cy + (r/2)*Math.sin(mid),
                t = document.createElementNS(svgNS,'text');
            t.setAttribute('x', lx);
            t.setAttribute('y', ly);
            t.setAttribute('text-anchor','middle');
            t.setAttribute('fill','#fff');
            t.setAttribute('font-size','10');
            t.textContent = labels[i] + '(' + v + ')';
            svg.appendChild(t);
            start = end;
        });
        cont.appendChild(svg);
    }

    function buildPieChartIncome(data) {
        const svgNS = 'http://www.w3.org/2000/svg',
            cont = document.getElementById('incomeChart'),
            sum = data.reduce((a,b)=>a+b,0);
        cont.innerHTML = '';
        if (sum<=0) {
            cont.innerHTML = "<p style='padding:10px;text-align:center;'>No income data</p>";
            return;
        }
        const size=200, cx=size/2, cy=size/2, r=cx-10,
            svg=document.createElementNS(svgNS,'svg');
        svg.setAttribute('width',size);
        svg.setAttribute('height',size);
        const cols = ['#FFD700','#FF69B4','#8A2BE2','#20B2AA','#F08080','#DEB887','#87CEEB','#FFA500','#C71585','#ADFF2F','#00FA9A','#FF6347'];
        let start=0;
        data.forEach((v,i)=>{
            if (!v) return;
            const angle=v/sum*2*Math.PI,
                end=start+angle,
                x1=cx+r*Math.cos(start),
                y1=cy+r*Math.sin(start),
                x2=cx+r*Math.cos(end),
                y2=cy+r*Math.sin(end),
                large=angle>Math.PI?1:0,
                d=`M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z`;
            const p=document.createElementNS(svgNS,'path');
            p.setAttribute('d',d);
            p.setAttribute('fill',cols[i%cols.length]);
            svg.appendChild(p);
            const mid=start+angle/2,
                lx=cx+(r/2)*Math.cos(mid),
                ly=cy+(r/2)*Math.sin(mid),
                t=document.createElementNS(svgNS,'text');
            t.setAttribute('x',lx);
            t.setAttribute('y',ly);
            t.setAttribute('text-anchor','middle');
            t.setAttribute('fill','#fff');
            t.setAttribute('font-size','10');
            t.textContent = i+1;
            svg.appendChild(t);
            start=end;
        });
        cont.appendChild(svg);
    }
    async function loadAssetsAndLiabilities() {
        try {
            const [assetsRes, liabilitiesRes] = await Promise.all([
                fetch('/api/assets', { credentials: 'include' }),
                fetch('/api/liabilities', { credentials: 'include' })
            ]);

            if (!assetsRes.ok || !liabilitiesRes.ok) {
                throw new Error('Failed to load assets or liabilities');
            }

            const assetsJson = await assetsRes.json();
            const liabilitiesJson = await liabilitiesRes.json();

            const total = arr => arr.reduce((sum, d) => {
                const v = d.fields?.amount?.doubleValue || 0;
                return sum + parseFloat(v);
            }, 0);

            const totalAssets = total(assetsJson.documents || []);
            const totalLiabilities = total(liabilitiesJson.documents || []);
            const netWorth = totalAssets - totalLiabilities;

            document.getElementById('netWorthValue').textContent = 'Net Worth: $' + netWorth.toFixed(2);
            document.getElementById('assetsValue').textContent = 'Assets: $' + totalAssets.toFixed(2);
            document.getElementById('liabilitiesValue').textContent = 'Liabilities: $' + totalLiabilities.toFixed(2);
        } catch (e) {
            console.error('Error loading net worth data:', e);
            document.getElementById('netWorthCard').innerHTML += '<p style="color:red;">Failed to load net worth info.</p>';
        }
    }
    // window.addEventListener('DOMContentLoaded', () => {
    //     loadAssetsAndLiabilities();
    // });
    function drawPieChart(containerId, dataMap, colors) {
        const svgNS = 'http://www.w3.org/2000/svg';
        const size = 200, cx = size / 2, cy = size / 2, r = cx - 10;
        const total = Array.from(dataMap.values()).reduce((sum, val) => sum + val, 0);

        const container = document.getElementById(containerId);
        container.innerHTML = '';

        if (total <= 0) {
            container.innerHTML = "<p style='text-align:center;'>No data</p>";
            return;
        }

        const svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('width', size);
        svg.setAttribute('height', size);

        let start = 0, i = 0;
        for (const [label, value] of dataMap.entries()) {
            if (!value) continue;
            const angle = (value / total) * 2 * Math.PI;
            const end = start + angle;

            const x1 = cx + r * Math.cos(start),
                y1 = cy + r * Math.sin(start),
                x2 = cx + r * Math.cos(end),
                y2 = cy + r * Math.sin(end),
                largeArc = angle > Math.PI ? 1 : 0;

            const pathData = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2} Z`;

            const path = document.createElementNS(svgNS, 'path');
            path.setAttribute('d', pathData);
            path.setAttribute('fill', colors[i % colors.length]);
            const tooltip = document.createElementNS(svgNS, 'title');
            tooltip.textContent = `${label}: $${value.toFixed(2)}`;
            path.appendChild(tooltip);
            svg.appendChild(path);

            const midAngle = start + angle / 2;
            const lx = cx + (r / 2) * Math.cos(midAngle),
                ly = cy + (r / 2) * Math.sin(midAngle);

            const text = document.createElementNS(svgNS, 'text');
            text.setAttribute('x', lx);
            text.setAttribute('y', ly);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', '#d97600');
            text.setAttribute('font-size', '15');
            text.textContent = label;
            svg.appendChild(text);

            start = end;
            i++;
        }
        container.appendChild(svg);
    }
    async function drawAssetLiabilityCharts() {
        try {
            const [assetsRes, liabilitiesRes] = await Promise.all([
                fetch('/api/assets', { credentials: 'include' }),
                fetch('/api/liabilities', { credentials: 'include' })
            ]);

            const assets = (await assetsRes.json()).documents || [];
            const liabilities = (await liabilitiesRes.json()).documents || [];

            const extractMap = docs => {
                const map = new Map();
                docs.forEach(d => {
                    const f = d.fields || {};
                    const name = f.name?.stringValue || 'Unnamed';
                    const amt = +f.amount?.doubleValue || 0;
                    map.set(name, amt);
                });
                return map;
            };
            const assetMap = extractMap(assets);
            const liabilityMap = extractMap(liabilities);
            const pieColors = ['', '#1E90FF', '#32CD32', '#FF69B4', '#FFD700', '#8A2BE2', '#FF6347','#4682B4', '#2E8B57', '#A52A2A', '#00CED1', '#DC143C', '#BDB76B', '#708090', '#6A5ACD'];
            drawPieChart('assetsPieChart', assetMap, pieColors);
            drawPieChart('liabilitiesPieChart', liabilityMap, pieColors);
        } catch (err) {
            console.error("Error drawing pie charts:", err);
        }
    }
    // window.addEventListener('DOMContentLoaded', () => {
    //     drawAssetLiabilityCharts();
    // });
    async function loadTax() {
        try {
            const res = await fetch('/api/tax', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });
            const data = await res.json();
            const docs = data.documents || [];

            if (!docs.length) {
                document.getElementById("totalTaxesDisplay").textContent = "No tax data available.";
                return;
            }
            const latest = docs[docs.length - 1];
            const resultText = latest.fields?.result?.stringValue || '';

            const fedMatch = resultText.match(/Estimated Federal Tax: \$([0-9.]+)/);
            const stateMatch = resultText.match(/Estimated State Tax: \$([0-9.]+)/);
            const totalMatch = resultText.match(/Estimated Total Tax Owed After Payments: \$([0-9.]+)/);

            const fedTax = fedMatch ? parseFloat(fedMatch[1]) : 0;
            const stateTax = stateMatch ? parseFloat(stateMatch[1]) : 0;
            const totalTax = totalMatch ? parseFloat(totalMatch[1]) : (fedTax + stateTax);

            document.getElementById("totalTaxesDisplay").textContent =
                "Total Owed: $" + totalTax.toFixed(2);

            const breakdown = new Map();
            breakdown.set("Federal", fedTax);
            breakdown.set("State", stateTax);

            drawPieChart("taxesPieChart", breakdown, ['#4CAF50', '#2196F3']);
        } catch (e) {
            console.error("Error loading tax data:", e);
            document.getElementById("totalTaxesDisplay").textContent = "Error loading tax info.";
        }
    }
    // window.addEventListener('DOMContentLoaded', () => {
    //     loadTax();
    // });
    let fullIncomeDocs = [];
    async function loadIncomeDataForDashboard() {
        try {
            const res = await fetch("/api/income", { credentials: 'include' });
            const data = await res.json();
            fullIncomeDocs = data.incomes || [];
            updateIncomeChart("year");
        } catch (err) {
            console.error("Error loading income:", err);
        }
    }
    function updateIncomeChart(selected) {
        const pieMap = new Map();
        let total = 0;

        fullIncomeDocs.forEach(doc => {
            const fields = doc.fields || {};
            const amount = parseFloat(fields.total?.doubleValue || 0);
            const name = fields.name?.stringValue || "Unnamed";
            const dateStr = fields.date?.stringValue || "";
            const recurring = fields.recurring?.stringValue === "true";
            const freq = fields.frequency?.stringValue || "";

            const date = new Date(dateStr);
            const month = date.getMonth();

            let count = 0;
            if (recurring) {
                switch (freq.toLowerCase()) {
                    case "weekly": count = 52; break;
                    case "biweekly": count = 26; break;
                    case "monthly": count = 12; break;
                    case "yearly": count = 1; break;
                    default: count = 0;
                }
            } else {
                if (!isNaN(month)) count = 1;
            }
            const isInSelectedMonth = !isNaN(month) && selected !== "year" && parseInt(selected) === month;
            const shouldInclude =
                (selected === "year" && count > 0) ||
                (selected !== "year" && (recurring || isInSelectedMonth));

            if (shouldInclude) {
                let incomeAmount = 0;
                if (recurring) {
                    const perMonth = (amount * count) / 12;
                    incomeAmount = selected === "year" ? perMonth * 12 : perMonth;
                } else {
                    incomeAmount = amount;
                }
                pieMap.set(name, (pieMap.get(name) || 0) + incomeAmount);
                total += incomeAmount;
            }
        });
        document.getElementById("incomeSummaryDisplay").textContent =
            `Total: $${total.toFixed(2)}`;
        drawPieChart("incomeTimePieChart", pieMap, ['#FFD700','#FF69B4','#8A2BE2','#20B2AA','#F08080','#DEB887','#87CEEB','#FFA500','#C71585','#ADFF2F','#00FA9A','#FF6347']);
        buildBarChartFromMap("incomeTimeBarChart", pieMap);

    }
    document.addEventListener('DOMContentLoaded', () => {
        loadIncomeDataForDashboard();
        document.getElementById("incomeTimeSelect").addEventListener("change", function () {
            updateIncomeChart(this.value);
        });
    });
    function buildBarChartFromMap(containerId, dataMap) {
        const svgNS = 'http://www.w3.org/2000/svg';
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        const labels = Array.from(dataMap.keys());
        const values = Array.from(dataMap.values());
        const maxVal = Math.max(...values, 1);

        const w = container.clientWidth || 500;
        const h = 300;
        const bw = w / values.length;

        const svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('width', w);
        svg.setAttribute('height', h);

        values.forEach((v, i) => {
            const ph = v / maxVal * (h - 40);
            const x = i * bw, y = h - ph;

            const r = document.createElementNS(svgNS, 'rect');
            r.setAttribute('x', x);
            r.setAttribute('y', y);
            r.setAttribute('width', bw - 4);
            r.setAttribute('height', ph);
            r.setAttribute('fill', '#1E90FF');

            const title = document.createElementNS(svgNS, 'title');
            title.textContent = `${labels[i]}: $${v.toFixed(2)}`;
            r.appendChild(title);

            svg.appendChild(r);

            const t = document.createElementNS(svgNS, 'text');
            t.setAttribute('x', x + (bw - 4) / 2);
            t.setAttribute('y', h - 5);
            t.setAttribute('fill', '#d97600');
            t.setAttribute('font-size', '10');
            t.setAttribute('text-anchor', 'middle');
            t.textContent = labels[i].length > 10 ? labels[i].slice(0, 10) + 'â€¦' : labels[i];
            svg.appendChild(t);
        });
        container.appendChild(svg);
    }
    let fullExpenseDocs = [];
    async function loadExpensesDataForDashboard() {
        try {
            const res = await fetch("/api/expenses", { credentials: 'include' });
            const data = await res.json();
            fullExpenseDocs = data.documents || [];
            updateExpensesPieChart("all");
            updateExpensesBarChart("all");
        } catch (err) {
            console.error("Error loading expenses:", err);
        }
    }
    function updateExpensesPieChart(selectedMonth) {
        const pieMap = new Map();
        let total = 0;

        fullExpenseDocs.forEach(doc => {
            const fields = doc.fields || {};
            const amount = parseFloat(fields.total?.doubleValue || 0);
            const category = fields.category?.stringValue || "Other";
            const dateStr = fields.date?.stringValue || "";

            const date = new Date(dateStr);
            const month = date.getMonth();

            const isInSelectedMonth = selectedMonth === "all" || (!isNaN(month) && parseInt(selectedMonth) === month);
            if (isInSelectedMonth) {
                pieMap.set(category, (pieMap.get(category) || 0) + amount);
                total += amount;
            }
        });
        document.getElementById("expensesSummaryDisplay").textContent = `Total: $${total.toFixed(2)}`;
        drawPieChart("expensesTimePieChart", pieMap, ['#FFD700','#FF69B4','#8A2BE2','#20B2AA','#F08080','#DEB887','#87CEEB','#FFA500','#C71585','#ADFF2F','#00FA9A','#FF6347']);
    }
    function updateExpensesBarChart(selectedMonth) {
        const barMap = new Map();
        fullExpenseDocs.forEach(doc => {
            const fields = doc.fields || {};
            const amount = parseFloat(fields.total?.doubleValue || 0);
            const name = fields.name?.stringValue || "Unnamed";
            const dateStr = fields.date?.stringValue || "";

            const date = new Date(dateStr);
            const month = date.getMonth();

            const isInSelectedMonth = selectedMonth === "all" || (!isNaN(month) && parseInt(selectedMonth) === month);
            if (isInSelectedMonth) {
                barMap.set(name, (barMap.get(name) || 0) + amount);
            }
        });

        buildBarChartFromMap("expensesTimeBarChart", barMap);
    }
    // document.addEventListener('DOMContentLoaded', () => {
    //     loadExpensesDataForDashboard();
    //     document.getElementById("expensesMonthSelect").addEventListener("change", function () {
    //         updateExpensesChart(this.value);
    //     });
    //     document.getElementById("expensesBarMonthSelect").addEventListener("change", function () {
    //         updateExpensesChart(this.value);
    //     });
    // });
    document.addEventListener('DOMContentLoaded', () => {
        const theme = getThemePreference('theme');
        if (theme) document.body.classList.add(theme + '-mode');

        const navImg = document.getElementById('navProfileImage');
        fetch('/api/profile', {
            method: 'GET',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(res => res.json())
            .then(data => {
                const img = data.fields?.profileImage?.stringValue;
                if (img) navImg.src = img;
            })
            .catch(() => navImg.src = 'default-avatar.png');
        loadAssetsAndLiabilities();
        drawAssetLiabilityCharts();
        loadTax();
        loadIncomeDataForDashboard();
        loadExpensesDataForDashboard();
        document.getElementById("incomeTimeSelect").addEventListener("change", function () {
            updateIncomeChart(this.value);
        });
        document.getElementById("expensesMonthSelect").addEventListener("change", function () {
            updateExpensesPieChart(this.value);
        });
        document.getElementById("expensesBarMonthSelect").addEventListener("change", function () {
            updateExpensesBarChart(this.value);
        });
    });
</script>
</body>
</html>
