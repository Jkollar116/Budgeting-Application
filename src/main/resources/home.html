<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CashClimb Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <!-- Add Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Include our API client -->
    <script src="app.js"></script>
    <style>
        /* Dashboard specific styles */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .card {
            background: #3E1F5B;
            border-radius: 12px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            margin-top: 0;
            color: #FF8C00;
            font-size: 1.5em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            font-size: 1.2em;
        }

        /* Chart container */
        .chart-container {
            position: relative;
            height: 220px;
            width: 100%;
        }

        /* Progress bar styles */
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: #FF8C00;
            border-radius: 10px;
        }

        /* Chart filter styles */
        .chart-filters {
            margin-bottom: 15px;
        }

        .chart-filter {
            background-color: rgba(62, 31, 91, 0.7);
            color: white;
            border: 1px solid rgba(255, 140, 0, 0.5);
            padding: 5px 10px;
            border-radius: 4px;
            width: 100%;
            max-width: 200px;
            font-size: 0.9em;
        }

        .filter-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background-color: rgba(62, 31, 91, 0.7);
            color: white;
            border: 1px solid rgba(255, 140, 0, 0.5);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background-color: rgba(255, 140, 0, 0.2);
        }

        .filter-btn.active {
            background-color: #FF8C00;
            color: white;
            border-color: #FF8C00;
        }

        .goal-item {
            background: rgba(62, 31, 91, 0.5);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .goal-item:hover {
            box-shadow: 0 2px 8px rgba(255, 140, 0, 0.3);
            border-color: rgba(255, 140, 0, 0.3);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .goal-header h3 {
            margin: 0;
            color: #FF8C00;
            font-size: 1.1em;
        }

        .goal-actions {
            display: flex;
            gap: 5px;
        }

        .goal-edit-btn, .goal-delete-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1em;
            padding: 2px 5px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .goal-edit-btn:hover, .goal-delete-btn:hover {
            opacity: 1;
        }

        .goal-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #e0e0e0;
        }

        .goal-percentage {
            font-weight: bold;
            color: #FF8C00;
        }

        .goal-estimate {
            font-size: 0.8em;
            color: #aaa;
            margin-top: 5px;
            text-align: right;
        }

        .btn-add-goal {
            background: #FF8C00;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
        }

        .btn-add-goal:hover {
            background: #ff9d2d;
        }

        /* Responsive grid */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        /* Loading spinner styles */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #aaa;
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin-bottom: 10px;
            border: 4px solid rgba(255, 140, 0, 0.2);
            border-radius: 50%;
            border-top-color: #FF8C00;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Refresh button hover effect */
        .refresh-btn {
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .refresh-btn:hover {
            opacity: 1;
            transform: rotate(30deg);
        }
    </style>
</head>
<body>
<header>
    <div class="logo">CashClimb</div>
    <nav>
        <ul class="nav-items">
            <li class="profile-link-container">
                <a href="profile.html">
                    <img id="navProfileImage" class="nav-profile-img" alt="Profile" />
                </a>
                <a href="profile.html" class="active">Profile</a>
            </li>
        </ul>
    </nav>
</header>
<button class="drawer-toggle" onclick="toggleDrawer()">☰</button>
<nav class="drawer" id="sideDrawer">
    <ul>
        <li><a href="home.html">Dashboard</a></li>
        <li><a href="alerts.html">Alerts Page (Not Done)</a></li>
        <li><a href="assetsLiabilities.html" class="active">Assets &amp; Liabilities</a></li>
        <li><a href="bills.html">Bills Page</a></li>
        <li><a href="budget.html">Budget</a></li>
        <li><a href="chat.html">Chat</a></li>
        <li><a href="crypto.html">Crypto</a></li>
        <li><a href="expenses.html">Expenses</a></li>
        <li><a href="income.html">Income</a></li>
        <li><a href="leaderboard.html">Leaderboard</a></li>
        <li><a href="netWorth.html">Net Worth</a></li>
        <li><a href="tips.html">Tips</a></li>
        <li><a href="savedTips.html">Saved Tips</a></li>
        <li><a href="stocks.html">Stocks</a></li>
        <li><a href="stocks-simple.html">Stocks Simple</a></li>
        <li><a href="tax.html">Tax</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="settings.html">Settings</a></li>
        <li><a href="/logout">Logout</a></li>
    </ul>
</nav>
<main>
    <section class="hero">
        <div class="hero-content">
            <h1>Dashboard</h1>
            <p>Your financial overview</p>
        </div>
    </section>
    <div class="dashboard">
        <div class="card" id="netWorthCard">
            <h2>💰 Net Worth</h2>
            <p id="netWorthDisplay">$0</p>
            <!-- Time period filter for net worth -->
            <div class="chart-filters">
                <select id="netWorthPeriod" class="chart-filter">
                    <option value="1m">1 Month</option>
                    <option value="3m">3 Months</option>
                    <option value="6m">6 Months</option>
                    <option value="1y" selected>1 Year</option>
                    <option value="all">All Time</option>
                </select>
            </div>
            <div class="chart-container">
                <canvas id="netWorthChart"></canvas>
            </div>
        </div>
        
        <div class="card" id="incomeCard">
            <h2>💵 Total Income</h2>
            <p id="totalIncomeDisplay">$0</p>
            <!-- Income type filter -->
            <div class="chart-filters">
                <div class="filter-buttons" id="incomeTypeFilter">
                    <button class="filter-btn active" data-value="all">All</button>
                    <button class="filter-btn" data-value="salary">Salary</button>
                    <button class="filter-btn" data-value="bonus">Bonus</button>
                    <button class="filter-btn" data-value="other">Other</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="incomeChart"></canvas>
            </div>
        </div>
        
        <div class="card" id="expensesCard">
            <h2>📊 Total Expenses</h2>
            <p id="totalExpensesDisplay">$0</p>
            <!-- Expense category filter -->
            <div class="chart-filters">
                <select id="expenseViewType" class="chart-filter">
                    <option value="category" selected>By Category</option>
                    <option value="monthly">By Month</option>
                    <option value="weekly">By Week</option>
                </select>
            </div>
            <div class="chart-container">
                <canvas id="expensesPieChart"></canvas>
            </div>
        </div>
        
        <div class="card" id="billsCard">
            <h2>📅 Bills Due</h2>
            <div id="billRemindersDisplay"><h1>0</h1></div>
        </div>
        
        <div class="card" id="chartCard">
            <h2>📈 Monthly Expenses</h2>
            <!-- Time period filter for monthly expenses -->
            <div class="chart-filters">
                <div class="filter-buttons" id="monthlyExpensesPeriod">
                    <button class="filter-btn" data-value="3m">3 Months</button>
                    <button class="filter-btn active" data-value="6m">6 Months</button>
                    <button class="filter-btn" data-value="1y">1 Year</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="monthlyExpensesChart"></canvas>
            </div>
        </div>
        
        <div class="card" id="goalsCard">
            <h2>🎯 Financial Goals</h2>
            <div class="chart-filters">
                <select id="goalsSortBy" class="chart-filter">
                    <option value="progress">Sort by Progress</option>
                    <option value="amount">Sort by Amount</option>
                    <option value="alphabet">Sort by Name</option>
                    <option value="recent" selected>Most Recent First</option>
                </select>
            </div>
            <div id="goals-container">
                <div class="goal-item" data-id="goal-1" data-progress="2500" data-target="5000">
                    <div class="goal-header">
                        <h3 class="goal-name">Emergency Fund</h3>
                        <div class="goal-actions">
                            <button class="goal-edit-btn" title="Update Progress"><i>✏️</i></button>
                            <button class="goal-delete-btn" title="Delete Goal"><i>🗑️</i></button>
                        </div>
                    </div>
                    <p class="goal-info">
                        <span class="goal-amount">$2,500 / $5,000</span>
                        <span class="goal-percentage">50%</span>
                    </p>
                    <div class="progress-bar">
                        <div class="progress" style="width: 50%"></div>
                    </div>
                    <p class="goal-estimate">Est. completion: <span>Dec 2025</span></p>
                </div>
                <div class="goal-item" data-id="goal-2" data-progress="800" data-target="2000">
                    <div class="goal-header">
                        <h3 class="goal-name">Vacation Savings</h3>
                        <div class="goal-actions">
                            <button class="goal-edit-btn" title="Update Progress"><i>✏️</i></button>
                            <button class="goal-delete-btn" title="Delete Goal"><i>🗑️</i></button>
                        </div>
                    </div>
                    <p class="goal-info">
                        <span class="goal-amount">$800 / $2,000</span>
                        <span class="goal-percentage">40%</span>
                    </p>
                    <div class="progress-bar">
                        <div class="progress" style="width: 40%"></div>
                    </div>
                    <p class="goal-estimate">Est. completion: <span>Oct 2025</span></p>
                </div>
                <div class="goal-item" data-id="goal-3" data-progress="3500" data-target="10000">
                    <div class="goal-header">
                        <h3 class="goal-name">New Car Down Payment</h3>
                        <div class="goal-actions">
                            <button class="goal-edit-btn" title="Update Progress"><i>✏️</i></button>
                            <button class="goal-delete-btn" title="Delete Goal"><i>🗑️</i></button>
                        </div>
                    </div>
                    <p class="goal-info">
                        <span class="goal-amount">$3,500 / $10,000</span>
                        <span class="goal-percentage">35%</span>
                    </p>
                    <div class="progress-bar">
                        <div class="progress" style="width: 35%"></div>
                    </div>
                    <p class="goal-estimate">Est. completion: <span>Mar 2026</span></p>
                </div>
                <button class="btn-add-goal" id="add-goal-btn">Add New Goal</button>
            </div>
        </div>
    </div>
</main>
<script>
    function toggleDrawer() {
        const drawer = document.getElementById('sideDrawer');
        drawer.classList.toggle('collapsed');
    }
    window.addEventListener("DOMContentLoaded", function () {
        fetch("/api/profile", {
            method: "GET",
            headers: { "Content-Type": "application/json" }
        })
            .then(res => res.json())
            .then(data => {
                const fields = data.fields || {};
                if (fields.profileImage) {
                    const base64Image = fields.profileImage.stringValue;
                    const navImg = document.getElementById("navProfileImage");
                    if (navImg) navImg.src = base64Image;
                }
            });
    });
    // Chart objects to track and update
    let netWorthChart, incomeChart, expensesPieChart, monthlyExpensesChart;
    
    function getThemePreference(name) {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        if (!match) return null;
        return match[2];
    }
    
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) window.location.reload();
    });
    
    window.addEventListener('DOMContentLoaded', () => {
        // Apply theme
        const savedTheme = getThemePreference('theme');
        const body = document.body;
        if (savedTheme === 'light') {
            body.classList.add('light-mode');
        } else if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
        }
        if (savedTheme) {
            const input = document.querySelector(`input[name="theme"][value="${savedTheme}"]`);
            if (input) input.checked = true;
        }
        
        // Add Goal Button Functionality
        const addGoalBtn = document.getElementById('add-goal-btn');
        if (addGoalBtn) {
            addGoalBtn.addEventListener('click', function() {
                showAddGoalForm();
            });
        }
    });
    
    function showAddGoalForm() {
        // Create modal for adding a new goal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';
        
        // Create form container
        const formContainer = document.createElement('div');
        formContainer.className = 'form-container';
        formContainer.style.backgroundColor = '#3E1F5B';
        formContainer.style.padding = '20px';
        formContainer.style.borderRadius = '10px';
        formContainer.style.width = '90%';
        formContainer.style.maxWidth = '500px';
        
        // Create form content
        formContainer.innerHTML = `
            <h3 style="color: #FF8C00; margin-top: 0;">Add New Financial Goal</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: white;">Goal Name</label>
                <input type="text" id="goal-name" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: white;">Target Amount ($)</label>
                <input type="number" id="goal-amount" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;" min="1">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: white;">Current Progress ($)</label>
                <input type="number" id="goal-progress" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;" min="0">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button id="cancel-goal" style="padding: 8px 15px; border-radius: 5px; border: none; background-color: #6c757d; color: white; cursor: pointer;">Cancel</button>
                <button id="save-goal" style="padding: 8px 15px; border-radius: 5px; border: none; background-color: #FF8C00; color: white; cursor: pointer;">Save Goal</button>
            </div>
        `;
        
        modal.appendChild(formContainer);
        document.body.appendChild(modal);
        
        // Add event listeners to buttons
        document.getElementById('cancel-goal').addEventListener('click', function() {
            document.body.removeChild(modal);
        });
        
        document.getElementById('save-goal').addEventListener('click', function() {
            const name = document.getElementById('goal-name').value;
            const amount = document.getElementById('goal-amount').value;
            const progress = document.getElementById('goal-progress').value;
            
            if (!name || !amount) {
                alert('Please fill out all required fields');
                return;
            }
            
            addGoalToList(name, parseFloat(progress) || 0, parseFloat(amount));
            document.body.removeChild(modal);
        });
    }
    
    function addGoalToList(name, progress, target) {
        const goalsContainer = document.getElementById('goals-container');
        const percent = Math.min(100, Math.round((progress / target) * 100));
        const goalId = 'goal-' + Date.now(); // Unique ID based on timestamp
        
        // Calculate estimated completion date (just for demo)
        const now = new Date();
        const monthsToComplete = progress > 0 ? Math.ceil((target - progress) / (progress * 0.2)) : 12;
        now.setMonth(now.getMonth() + monthsToComplete);
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const completionDate = monthNames[now.getMonth()] + ' ' + now.getFullYear();
        
        const goalItem = document.createElement('div');
        goalItem.className = 'goal-item';
        goalItem.dataset.id = goalId;
        goalItem.dataset.progress = progress;
        goalItem.dataset.target = target;
        goalItem.innerHTML = `
            <div class="goal-header">
                <h3 class="goal-name">${name}</h3>
                <div class="goal-actions">
                    <button class="goal-edit-btn" title="Update Progress"><i>✏️</i></button>
                    <button class="goal-delete-btn" title="Delete Goal"><i>🗑️</i></button>
                </div>
            </div>
            <p class="goal-info">
                <span class="goal-amount">$${progress.toLocaleString()} / $${target.toLocaleString()}</span>
                <span class="goal-percentage">${percent}%</span>
            </p>
            <div class="progress-bar">
                <div class="progress" style="width: ${percent}%"></div>
            </div>
            <p class="goal-estimate">Est. completion: <span>${completionDate}</span></p>
        `;
        
        // Insert the new goal before the add button
        const addButton = document.getElementById('add-goal-btn');
        goalsContainer.insertBefore(goalItem, addButton);
        
        // Add event listeners to the new goal's buttons
        setupGoalItemListeners(goalItem);
        
        // Sort goals after adding
        sortGoals();
    }
    
    function setupGoalItemListeners(goalItem) {
        // Edit button functionality
        const editBtn = goalItem.querySelector('.goal-edit-btn');
        if (editBtn) {
            editBtn.addEventListener('click', function() {
                const goalId = goalItem.dataset.id;
                const currentProgress = parseFloat(goalItem.dataset.progress);
                const targetAmount = parseFloat(goalItem.dataset.target);
                const goalName = goalItem.querySelector('.goal-name').textContent;
                
                showUpdateProgressModal(goalId, goalName, currentProgress, targetAmount);
            });
        }
        
        // Delete button functionality
        const deleteBtn = goalItem.querySelector('.goal-delete-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                // Ask for confirmation
                if (confirm("Are you sure you want to delete this goal?")) {
                    goalItem.remove();
                }
            });
        }
    }
    
    function showUpdateProgressModal(goalId, goalName, currentProgress, targetAmount) {
        // Create modal for updating progress
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';
        
        // Create form container
        const formContainer = document.createElement('div');
        formContainer.className = 'form-container';
        formContainer.style.backgroundColor = '#3E1F5B';
        formContainer.style.padding = '20px';
        formContainer.style.borderRadius = '10px';
        formContainer.style.width = '90%';
        formContainer.style.maxWidth = '500px';
        
        // Create form content
        formContainer.innerHTML = `
            <h3 style="color: #FF8C00; margin-top: 0;">Update Goal Progress</h3>
            <p style="color: white; margin-bottom: 20px;">Goal: ${goalName}</p>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: white;">Current Progress ($)</label>
                <input type="number" id="update-progress" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;" min="0" max="${targetAmount}" value="${currentProgress}">
                <p style="color: #aaa; font-size: 0.9em; margin-top: 5px;">Target: $${targetAmount.toLocaleString()}</p>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button id="cancel-update" style="padding: 8px 15px; border-radius: 5px; border: none; background-color: #6c757d; color: white; cursor: pointer;">Cancel</button>
                <button id="save-update" style="padding: 8px 15px; border-radius: 5px; border: none; background-color: #FF8C00; color: white; cursor: pointer;">Save</button>
            </div>
        `;
        
        modal.appendChild(formContainer);
        document.body.appendChild(modal);
        
        // Add event listeners to buttons
        document.getElementById('cancel-update').addEventListener('click', function() {
            document.body.removeChild(modal);
        });
        
        document.getElementById('save-update').addEventListener('click', function() {
            const newProgress = parseFloat(document.getElementById('update-progress').value);
            if (isNaN(newProgress) || newProgress < 0 || newProgress > targetAmount) {
                alert('Please enter a valid progress amount between 0 and ' + targetAmount);
                return;
            }
            
            updateGoalProgress(goalId, newProgress, targetAmount);
            document.body.removeChild(modal);
        });
    }
    
    function updateGoalProgress(goalId, newProgress, targetAmount) {
        const goalItem = document.querySelector(`.goal-item[data-id="${goalId}"]`);
        if (!goalItem) return;
        
        // Update data attributes
        goalItem.dataset.progress = newProgress;
        
        // Calculate percent
        const percent = Math.min(100, Math.round((newProgress / targetAmount) * 100));
        
        // Update visual elements
        goalItem.querySelector('.goal-amount').textContent = `$${newProgress.toLocaleString()} / $${targetAmount.toLocaleString()}`;
        goalItem.querySelector('.goal-percentage').textContent = `${percent}%`;
        goalItem.querySelector('.progress').style.width = `${percent}%`;
        
        // Update estimated completion date
        const now = new Date();
        const monthsToComplete = newProgress > 0 ? Math.ceil((targetAmount - newProgress) / (newProgress * 0.2)) : 12;
        now.setMonth(now.getMonth() + monthsToComplete);
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const completionDate = monthNames[now.getMonth()] + ' ' + now.getFullYear();
        goalItem.querySelector('.goal-estimate span').textContent = completionDate;
        
        // Resort goals because progress has changed
        sortGoals();
    }
    
    function sortGoals() {
        const goalsSortBy = document.getElementById('goalsSortBy');
        if (!goalsSortBy) return;
        
        const sortValue = goalsSortBy.value;
        const goalsContainer = document.getElementById('goals-container');
        const addButton = document.getElementById('add-goal-btn');
        
        // Get all goal items except the add button
        const goals = Array.from(goalsContainer.querySelectorAll('.goal-item'));
        
        // Sort based on selected criteria
        switch (sortValue) {
            case 'progress':
                goals.sort((a, b) => {
                    const aProgress = parseFloat(a.dataset.progress) / parseFloat(a.dataset.target);
                    const bProgress = parseFloat(b.dataset.progress) / parseFloat(b.dataset.target);
                    return bProgress - aProgress; // Highest progress first
                });
                break;
            case 'amount':
                goals.sort((a, b) => {
                    const aTarget = parseFloat(a.dataset.target);
                    const bTarget = parseFloat(b.dataset.target);
                    return bTarget - aTarget; // Highest amount first
                });
                break;
            case 'alphabet':
                goals.sort((a, b) => {
                    const aName = a.querySelector('.goal-name').textContent;
                    const bName = b.querySelector('.goal-name').textContent;
                    return aName.localeCompare(bName);
                });
                break;
            case 'recent':
                // No need to sort by ID since we're using timestamps
                // Newest goals already have the highest ID value
                goals.sort((a, b) => {
                    const aId = a.dataset.id.replace('goal-', '');
                    const bId = b.dataset.id.replace('goal-', '');
                    return parseInt(bId) - parseInt(aId); // Newest first
                });
                break;
        }
        
        // Remove all goals from container
        goals.forEach(goal => goal.remove());
        
        // Add sorted goals back before the add button
        goals.forEach(goal => {
            goalsContainer.insertBefore(goal, addButton);
        });
    }
    
    // Setup chart filters function
    function setupChartFilters() {
        // 1. Net Worth Period Selector
        const netWorthPeriod = document.getElementById('netWorthPeriod');
        if (netWorthPeriod) {
            netWorthPeriod.addEventListener('change', function() {
                const period = this.value;
                console.log(`Net Worth period changed to: ${period}`);
                updateNetWorthChart(period);
            });
        }
        
        // 2. Income Type Filter
        const incomeFilterButtons = document.querySelectorAll('#incomeTypeFilter .filter-btn');
        incomeFilterButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                incomeFilterButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                
                const type = this.getAttribute('data-value');
                console.log(`Income type filter changed to: ${type}`);
                updateIncomeChart(type);
            });
        });
        
        // 3. Expense View Type
        const expenseViewType = document.getElementById('expenseViewType');
        if (expenseViewType) {
            expenseViewType.addEventListener('change', function() {
                const viewType = this.value;
                console.log(`Expense view type changed to: ${viewType}`);
                updateExpenseChart(viewType);
            });
        }
        
        // 4. Monthly Expenses Period
        const monthlyExpensesButtons = document.querySelectorAll('#monthlyExpensesPeriod .filter-btn');
        monthlyExpensesButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                monthlyExpensesButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                
                const period = this.getAttribute('data-value');
                console.log(`Monthly expenses period changed to: ${period}`);
                updateMonthlyExpensesChart(period);
            });
        });
        
        // 5. Goals Sort By
        const goalsSortBy = document.getElementById('goalsSortBy');
        if (goalsSortBy) {
            goalsSortBy.addEventListener('change', function() {
                const sortValue = this.value;
                console.log(`Goals sort changed to: ${sortValue}`);
                sortGoals();
            });
        }
        
        // 6. Setup Goal Item Listeners
        document.querySelectorAll('.goal-item').forEach(goalItem => {
            setupGoalItemListeners(goalItem);
        });
    }
    
    // Helper functions for handling data
    function getInt(field) {
        return field && field.integerValue ? parseInt(field.integerValue) : 0;
    }
    
    function getArray(arrayField) {
        return arrayField && arrayField.arrayValue && arrayField.arrayValue.values ? arrayField.arrayValue.values : [];
    }
    
    // Update Functions for Each Chart
    function updateNetWorthChart(period) {
        // Fetch the latest data using our API client
        fetchDashboardData()
            .then(data => {
                const fields = data.fields || {};
                
                // Try to parse the netWorthBreakdown from string to object
                let breakdown = { cash: 0, stocks: 0, crypto: 0 };
                
                // Parse the netWorthBreakdown from Firebase
                if (fields.netWorthBreakdown && fields.netWorthBreakdown.stringValue) {
                    try {
                        breakdown = JSON.parse(fields.netWorthBreakdown.stringValue);
                    } catch (err) {
                        console.error("Error parsing netWorthBreakdown:", err);
                    }
                }
                
                // Apply period filter (in a real app, this might fetch different data for each period)
                // For now, we're just using the same data for all periods
                
                // Update chart
                if (netWorthChart) {
                    netWorthChart.data.datasets[0].data = Object.values(breakdown);
                    netWorthChart.update();
                } else {
                    createNetWorthChart(fields);
                }
                
                // Update total net worth display
                const totalNetWorth = Object.values(breakdown).reduce((sum, val) => sum + val, 0);
                document.getElementById('netWorthDisplay').textContent = formatCurrency(totalNetWorth);
            })
            .catch(err => {
                console.error("Error fetching net worth data:", err);
            });
    }
    
    function updateIncomeChart(type) {
        // Fetch the latest data using our API client
        fetchDashboardData()
            .then(data => {
                const fields = data.fields || {};
                
                // Try to parse the income breakdown from Firebase
                let fullBreakdown = { salary: 0, bonus: 0, other: 0 };
                
                if (fields.totalIncomeBreakdown && fields.totalIncomeBreakdown.stringValue) {
                    try {
                        fullBreakdown = JSON.parse(fields.totalIncomeBreakdown.stringValue);
                    } catch (err) {
                        console.error("Error parsing totalIncomeBreakdown:", err);
                    }
                }
                
                // Filter based on selected type
                let filteredBreakdown;
                if (type === 'all') {
                    filteredBreakdown = fullBreakdown;
                } else {
                    filteredBreakdown = {};
                    if (type in fullBreakdown) {
                        filteredBreakdown[type] = fullBreakdown[type];
                    }
                }
                
                // Update chart
                if (incomeChart) {
                    incomeChart.data.labels = Object.keys(filteredBreakdown).map(k => k.charAt(0).toUpperCase() + k.slice(1));
                    incomeChart.data.datasets[0].data = Object.values(filteredBreakdown);
                    incomeChart.update();
                } else {
                    createIncomeChart(fields);
                }
                
                // Update total income display
                const totalIncome = Object.values(filteredBreakdown).reduce((sum, val) => sum + val, 0);
                document.getElementById('totalIncomeDisplay').textContent = formatCurrency(totalIncome);
            })
            .catch(err => {
                console.error("Error fetching income data:", err);
            });
    }
    
    function updateExpenseChart(viewType) {
        // Get expenses container and clear it
        const container = document.getElementById('expensesPieChart');
        
        if (expensesPieChart) {
            expensesPieChart.destroy();
        }
        
        // Fetch data from API
        fetchExpensesData()
            .then(data => {
                const docs = data.documents || [];
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                // Different data organization based on view type
                let chartData = {}, chartType;
                
                if (viewType === 'category') {
                    // Group by category
                    docs.forEach(doc => {
                        const category = doc.fields.category?.stringValue;
                        const amount = parseFloat(doc.fields.total?.doubleValue) || 0;
                        
                        if (category) {
                            chartData[category] = (chartData[category] || 0) + amount;
                        }
                    });
                    chartType = 'pie';
                } 
                else if (viewType === 'monthly') {
                    // Group by month
                    const monthlyTotals = Array(12).fill(0);
                    
                    docs.forEach(doc => {
                        const dateStr = doc.fields.date?.stringValue;
                        const amount = parseFloat(doc.fields.total?.doubleValue) || 0;
                        
                        if (dateStr) {
                            const date = new Date(dateStr);
                            if (!isNaN(date)) {
                                const month = date.getMonth();
                                monthlyTotals[month] += amount;
                            }
                        }
                    });
                    
                    // Create chart data object with month names
                    monthNames.forEach((name, index) => {
                        if (monthlyTotals[index] > 0) {
                            chartData[name] = monthlyTotals[index];
                        }
                    });
                    chartType = 'bar';
                }
                else if (viewType === 'weekly') {
                    // Group by week (simplified: just last 4 weeks)
                    const weeksData = {'Week 1': 0, 'Week 2': 0, 'Week 3': 0, 'Week 4': 0};
                    const today = new Date();
                    
                    docs.forEach(doc => {
                        const dateStr = doc.fields.date?.stringValue;
                        const amount = parseFloat(doc.fields.total?.doubleValue) || 0;
                        
                        if (dateStr) {
                            const date = new Date(dateStr);
                            if (!isNaN(date)) {
                                const daysDiff = Math.floor((today - date) / (1000 * 60 * 60 * 24));
                                
                                if (daysDiff <= 7) weeksData['Week 1'] += amount;
                                else if (daysDiff <= 14) weeksData['Week 2'] += amount;
                                else if (daysDiff <= 21) weeksData['Week 3'] += amount;
                                else if (daysDiff <= 28) weeksData['Week 4'] += amount;
                            }
                        }
                    });
                    
                    chartData = weeksData;
                    chartType = 'bar';
                }
                
                // If no data found, show empty state
                if (Object.keys(chartData).length === 0) {
                    chartData = {'No Data': 0};
                }
                
                // Create chart with selected data
                const ctx = container.getContext('2d');
                
                // Generate colors based on number of data points
                const numItems = Object.keys(chartData).length;
                const backgroundColors = [];
                const borderColors = [];
                
                for(let i = 0; i < numItems; i++) {
                    const hue = (i * 360 / numItems) % 360;
                    backgroundColors.push(`hsla(${hue}, 70%, 60%, 0.7)`);
                    borderColors.push(`hsl(${hue}, 70%, 60%)`);
                }
                
                // Create new chart
                expensesPieChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: Object.keys(chartData),
                        datasets: [{
                            data: Object.values(chartData),
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return label + ': ' + formatCurrency(value) + (chartType === 'pie' ? ` (${percentage}%)` : '');
                                    }
                                }
                            }
                        },
                        scales: chartType !== 'pie' ? {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        } : {}
                    }
                });
                
                // Update total expenses display
                const totalExpenses = Object.values(chartData).reduce((sum, val) => sum + val, 0);
                document.getElementById('totalExpensesDisplay').textContent = formatCurrency(totalExpenses);
            })
            .catch(err => {
                console.error("Error processing expense data:", err);
                // On error, create empty chart
                const ctx = container.getContext('2d');
                expensesPieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['No Data'],
                        datasets: [{
                            data: [0],
                            backgroundColor: ['rgba(200, 200, 200, 0.5)'],
                            borderColor: ['rgb(200, 200, 200)']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            });
    }
    
    function updateMonthlyExpensesChart(period) {
        // Determine how many months to show based on the selected period
        let numMonths;
        switch(period) {
            case '3m': numMonths = 3; break;
            case '6m': numMonths = 6; break;
            case '1y': numMonths = 12; break;
            default: numMonths = 6;
        }
        
        // Fetch the latest data
        fetchDashboardData()
            .then(data => {
                const fields = data.fields || {};
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                // Get monthly expenses from the data
                const monthlyExpensesArr = getArray(fields.monthlyExpenses).map(item => getInt(item));
                
                // Get current month index (0-11)
                const currentMonth = new Date().getMonth();
                
                // Calculate month labels working backwards from current month
                const labels = [];
                for (let i = 0; i < numMonths; i++) {
                    const monthIndex = (currentMonth - i + 12) % 12; // Handle wrapping around to previous year
                    labels.unshift(monthNames[monthIndex]);
                }
                
                // Update chart
                if (monthlyExpensesChart) {
                    monthlyExpensesChart.data.labels = labels;
                    monthlyExpensesChart.data.datasets[0].data = monthlyExpensesArr.slice(-numMonths);
                    monthlyExpensesChart.update();
                } else {
                    createMonthlyExpensesChart(monthlyExpensesArr);
                }
            })
            .catch(err => {
                console.error("Error fetching monthly expenses data:", err);
            });
    }
    
    // Refresh data periodically and on page load
    function refreshDashboardData() {
        console.log("Refreshing dashboard data...");
        
        // Show loading indicators with timeout tracking
        const loadingTimeout = {};
        document.querySelectorAll('.chart-container').forEach(container => {
            const chartId = container.querySelector('canvas')?.id || 'unknown';
            container.innerHTML = "<div class='loading-spinner' id='spinner-" + chartId + "'><div class='spinner'></div><p>Loading data...</p></div>";
            
            // Set a timeout to show "Taking longer than expected" message after 5 seconds
            loadingTimeout[chartId] = setTimeout(() => {
                const spinner = document.getElementById('spinner-' + chartId);
                if (spinner) {
                    spinner.innerHTML = "<div class='spinner'></div><p>Taking longer than expected...</p><p style='font-size:0.8em;color:#aaa;'>Data services may be unavailable</p>";
                }
            }, 5000);
        });
        
        // Fetch dashboard data from our API client with timeout handling
        fetchDashboardData()
            .then(data => {
                // Clear all timeouts
                Object.values(loadingTimeout).forEach(timeout => clearTimeout(timeout));
                
                const fields = data.fields || {};
                
                // Update dashboard displays with the latest data
                const netWorth = getInt(fields.netWorth);
                document.getElementById("netWorthDisplay").textContent = formatCurrency(netWorth);
                
                const totalIncome = getInt(fields.totalIncome);
                document.getElementById("totalIncomeDisplay").textContent = formatCurrency(totalIncome);
                
                const totalExpenses = getInt(fields.totalExpenses);
                document.getElementById("totalExpensesDisplay").textContent = formatCurrency(totalExpenses);
                
                const billsDue = getInt(fields.billsDue);
                document.getElementById("billRemindersDisplay").innerHTML = "<h1>" + billsDue + "</h1>";
                
                const monthlyExpensesArr = getArray(fields.monthlyExpenses).map(item => getInt(item));
                const monthlyIncomesArr = getArray(fields.monthlyIncomes).map(item => getInt(item));
                
                console.log("Dashboard data refreshed:");
                console.log("- Monthly Income:", monthlyIncomesArr);
                console.log("- Monthly Expenses:", monthlyExpensesArr);
                console.log("- Income Breakdown:", fields.totalIncomeBreakdown?.stringValue);
                
                // Create or update charts with latest data - check for empty data
                if (hasChartData(fields)) {
                    try {
                        createNetWorthChart(fields);
                        createIncomeChart(fields);
                        createExpensePieChart(fields);
                        createMonthlyExpensesChart(monthlyExpensesArr);
                    } catch (e) {
                        console.error("Error creating charts:", e);
                        showNoDataMessage("netWorthChart", "Error creating chart. Please try refreshing.");
                        showNoDataMessage("incomeChart", "Error creating chart. Please try refreshing.");
                        showNoDataMessage("expensesPieChart", "Error creating chart. Please try refreshing.");
                        showNoDataMessage("monthlyExpensesChart", "Error creating chart. Please try refreshing.");
                    }
                } else {
                    showNoDataMessage("netWorthChart", "No net worth data available yet. Add assets and income sources to see data.");
                    showNoDataMessage("incomeChart", "No income data available yet. Add income sources on the income page.");
                    showNoDataMessage("expensesPieChart", "No expense data available. Add expenses on the expenses page.");
                    showNoDataMessage("monthlyExpensesChart", "No monthly expense data available yet.");
                }
            })
            .catch(err => {
                // Clear all timeouts
                Object.values(loadingTimeout).forEach(timeout => clearTimeout(timeout));
                
                console.error("Error fetching dashboard data:", err);
                
                // Show user-friendly error message on dashboard
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.innerHTML = `
                        <div class="no-data-message">
                            <p style="color:#ff6b6b;"><strong>Unable to load chart data</strong></p>
                            <p style="font-size:0.9em;color:#ddd;">The data service is currently unavailable.</p>
                            <button class="retry-btn" onclick="refreshDashboardData()">Try Again</button>
                        </div>
                    `;
                });
                
                // Reset display values to zero
                document.getElementById("netWorthDisplay").textContent = "$0.00";
                document.getElementById("totalIncomeDisplay").textContent = "$0.00";
                document.getElementById("totalExpensesDisplay").textContent = "$0.00";
                document.getElementById("billRemindersDisplay").innerHTML = "<h1>0</h1>";
            });
    }
    
    // Check if there's any actual data to display in charts
    function hasChartData(fields) {
        // Check if any of the key data points have real values
        const netWorth = getInt(fields.netWorth);
        const totalIncome = getInt(fields.totalIncome);
        const totalExpenses = getInt(fields.totalExpenses);
        
        // Check breakdown objects
        let hasBreakdownData = false;
        try {
            const netWorthBreakdown = JSON.parse(fields.netWorthBreakdown?.stringValue || "{}");
            const incomeBreakdown = JSON.parse(fields.totalIncomeBreakdown?.stringValue || "{}");
            
            // Check if any breakdown has non-zero values
            hasBreakdownData = Object.values(netWorthBreakdown).some(val => val > 0) || 
                               Object.values(incomeBreakdown).some(val => val > 0);
        } catch (e) {
            console.error("Error parsing breakdown data:", e);
        }
        
        // Check monthly arrays
        const monthlyExpenses = getArray(fields.monthlyExpenses).map(item => getInt(item));
        const monthlyIncomes = getArray(fields.monthlyIncomes).map(item => getInt(item));
        
        const hasMonthlyData = monthlyExpenses.some(val => val > 0) || 
                              monthlyIncomes.some(val => val > 0);
        
        // Return true if we have any meaningful data to display
        return netWorth > 0 || totalIncome > 0 || totalExpenses > 0 || 
               hasBreakdownData || hasMonthlyData;
    }
    
    // Show a "no data" message where a chart would be
    function showNoDataMessage(chartId, message) {
        const canvas = document.getElementById(chartId);
        if (!canvas) return;
        
        const container = canvas.parentElement;
        if (container) {
            container.innerHTML = `<div class="no-data-message">
                <p>${message}</p>
                <p class="empty-tip">Enter data on other pages to see changes here.</p>
            </div>`;
        }
    }
    
    // Main initialization on page load
    document.addEventListener("DOMContentLoaded", function() {
        // Set up chart filter event listeners
        setupChartFilters();
        
        // Apply theme from cookies
        const savedTheme = getThemePreference('theme');
        const body = document.body;
        if (savedTheme === 'light') {
            body.classList.add('light-mode');
        } else if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
        }
        if (savedTheme) {
            const input = document.querySelector(`input[name="theme"][value="${savedTheme}"]`);
            if (input) input.checked = true;
        }
        
        // Setup goal button click handler
        const addGoalBtn = document.getElementById('add-goal-btn');
        if (addGoalBtn) {
            addGoalBtn.addEventListener('click', function() {
                showAddGoalForm();
            });
        }
        
        // Add refresh button to each chart card
        document.querySelectorAll('.card h2').forEach(heading => {
            const refreshBtn = document.createElement('button');
            refreshBtn.innerHTML = '🔄';
            refreshBtn.className = 'refresh-btn';
            refreshBtn.style.marginLeft = 'auto';
            refreshBtn.style.background = 'none';
            refreshBtn.style.border = 'none';
            refreshBtn.style.color = 'white';
            refreshBtn.style.fontSize = '1em';
            refreshBtn.style.cursor = 'pointer';
            refreshBtn.title = 'Refresh data';
            refreshBtn.addEventListener('click', refreshDashboardData);
            heading.appendChild(refreshBtn);
        });
        
        // Initial data load
        refreshDashboardData();
        
        // Add an event listener for when the page becomes visible again
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // Refresh data when the user returns to this tab
                refreshDashboardData();
            }
        });
        
        // Set up auto-refresh timer (refresh every 60 seconds)
        setInterval(refreshDashboardData, 60000);
    });
    
    // Chart creation functions
    function createNetWorthChart(fields) {
        const ctx = document.getElementById('netWorthChart').getContext('2d');
        
        try {
            // Try to parse the netWorthBreakdown from string to object
            let breakdown = { cash: 0, stocks: 0, crypto: 0 };
            
            // Parse the netWorthBreakdown from Firebase
            if (fields.netWorthBreakdown && fields.netWorthBreakdown.stringValue) {
                try {
                    breakdown = JSON.parse(fields.netWorthBreakdown.stringValue);
                } catch (err) {
                    console.error("Error parsing netWorthBreakdown:", err);
                }
            }
            
            // Destroy previous chart if it exists
            if (netWorthChart) {
                netWorthChart.destroy();
            }
            
            // Create new chart
            netWorthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(breakdown).map(k => k.charAt(0).toUpperCase() + k.slice(1)),
                    datasets: [{
                        label: 'Value ($)',
                        data: Object.values(breakdown),
                        backgroundColor: [
                            'rgba(50, 205, 50, 0.7)',  // cash - green
                            'rgba(30, 144, 255, 0.7)', // stocks - blue
                            'rgba(255, 140, 0, 0.7)'   // crypto - orange
                        ],
                        borderColor: [
                            'rgb(50, 205, 50)',
                            'rgb(30, 144, 255)',
                            'rgb(255, 140, 0)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        } catch (err) {
            console.error("Error creating net worth chart:", err);
        }
    }
    
    // Create Income Chart
    function createIncomeChart(fields) {
        const ctx = document.getElementById('incomeChart').getContext('2d');
        
        try {
            // Default empty income breakdown
            let incomeBreakdown = { salary: 0, bonus: 0, other: 0 };
            
            // Parse the totalIncomeBreakdown from Firebase
            if (fields.totalIncomeBreakdown && fields.totalIncomeBreakdown.stringValue) {
                try {
                    incomeBreakdown = JSON.parse(fields.totalIncomeBreakdown.stringValue);
                } catch (err) {
                    console.error("Error parsing totalIncomeBreakdown:", err);
                }
            }
            
            // Destroy previous chart if it exists
            if (incomeChart) {
                incomeChart.destroy();
            }
            
            // Create new doughnut chart
            incomeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(incomeBreakdown).map(k => k.charAt(0).toUpperCase() + k.slice(1)),
                    datasets: [{
                        data: Object.values(incomeBreakdown),
                        backgroundColor: [
                            'rgba(255, 215, 0, 0.7)',   // salary - gold
                            'rgba(255, 105, 180, 0.7)', // bonus - pink
                            'rgba(138, 43, 226, 0.7)'   // other - purple
                        ],
                        borderColor: [
                            'rgb(255, 215, 0)',
                            'rgb(255, 105, 180)',
                            'rgb(138, 43, 226)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return label + ': ' + formatCurrency(value) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        } catch (err) {
            console.error("Error creating income chart:", err);
        }
    }
    
    // Create Expense Pie Chart
    function createExpensePieChart(fields) {
        // We'll use the updateExpenseChart function since it already handles the API call
        updateExpenseChart('category');
    }
    
    // Create Monthly Expenses Chart
    function createMonthlyExpensesChart(monthlyExpensesArr) {
        const ctx = document.getElementById('monthlyExpensesChart').getContext('2d');
        
        try {
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            // Ensure we have 12 months of data
            if (monthlyExpensesArr.length < 12) {
                monthlyExpensesArr = Array(12).fill(0).map((v, i) => 
                    i < monthlyExpensesArr.length ? monthlyExpensesArr[i] : 0
                );
            }
            
            // Destroy previous chart if it exists
            if (monthlyExpensesChart) {
                monthlyExpensesChart.destroy();
            }
            
            // Create new line chart
            monthlyExpensesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: [{
                        label: 'Monthly Expenses',
                        data: monthlyExpensesArr,
                        backgroundColor: 'rgba(255, 140, 0, 0.2)',
                        borderColor: 'rgb(255, 140, 0)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: 'rgb(255, 140, 0)',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        } catch (err) {
            console.error("Error creating monthly expenses chart:", err);
        }
    }
</script>
