<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BudgetApp Home</title>
    <link rel="stylesheet" href="style.css">
    <!-- Add Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
    <div class="logo">CashClimb</div>
    <nav>
        <ul>
            <li><a href="profile.html">Profile</a></li>
        </ul>
    </nav>
</header>
<button class="drawer-toggle" onclick="toggleDrawer()">â˜°</button>
<nav class="drawer" id="sideDrawer">
    <ul>
        <li><a href="home.html">Dashboard</a></li>
        <li><a href="expenses.html">Expenses</a></li>
        <li><a href="income.html">Income</a></li>
        <li><a href="tax.html">Tax</a></li>
        <li><a href="crypto.html">Crypto</a></li>
        <li><a href="stocks.html">Stocks</a></li>
        <li><a href="chat.html">Chat</a></li>
        <li><a href="tips.html">Tips</a></li>
        <li><a href="savedTips.html">Saved Tips</a></li>
        <li><a href="assetsLiabilities.html" class="active">Assets &amp; Liabilities</a></li>
        <li><a href="budget.html">Budget</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="settings.html">Settings</a></li>
        <li><a href="/logout">Logout</a></li>
        <li><a href="bills.html">Bills Page (Not Done)</a></li>
        <li><a href="leaderboard.html">Leaderboard</a></li>
    </ul>
</nav>
<main>
<section class="hero">
    <div class="hero-content">
        <h1>Dashboard</h1>
        <p>Your financial overview</p>
    </div>
</section>
<div class="dashboard">
    <div class="card" id="netWorthCard">
        <h2><span class="icon">ðŸ’°</span> Net Worth</h2>
        <p id="netWorthDisplay"></p>
        <div class="chart-container">
            <canvas id="netWorthChart"></canvas>
        </div>
    </div>
    <div class="card" id="incomeCard">
        <h2><span class="icon">ðŸ’µ</span> Total Income</h2>
        <p id="totalIncomeDisplay"></p>
        <div class="chart-container">
            <canvas id="incomeChart"></canvas>
        </div>
    </div>
    <div class="card" id="expensesCard">
        <h2><span class="icon">ðŸ’¸</span> Total Expenses</h2>
        <p id="totalExpensesDisplay"></p>
        <div class="chart-container">
            <canvas id="expensesPieChart"></canvas>
        </div>
    </div>
    <div class="card" id="billsCard">
        <h2><span class="icon">ðŸ“…</span> Bills Due</h2>
        <div id="billRemindersDisplay"></div>
    </div>
    <div class="card" id="chartCard">
        <h2><span class="icon">ðŸ“Š</span> Monthly Expenses</h2>
        <div class="chart-container">
            <canvas id="monthlyExpensesChart"></canvas>
        </div>
    </div>
    <!-- New card for financial goals -->
    <div class="card" id="goalsCard">
        <h2><span class="icon">ðŸŽ¯</span> Financial Goals</h2>
        <div id="goalsContainer">
            <!-- Goals will be inserted here -->
            <div class="goal-container">
                <div class="goal-title">
                    <span>Emergency Fund</span>
                    <span>$2,500 / $5,000</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 50%"></div>
                </div>
            </div>
            <div class="goal-container">
                <div class="goal-title">
                    <span>Vacation Savings</span>
                    <span>$800 / $2,000</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 40%"></div>
                </div>
            </div>
            <!-- Button to add new goal -->
            <button id="addGoalBtn" style="margin-top: 10px; padding: 8px; background: #FF8C00; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Add New Goal
            </button>
        </div>
    </div>
</div>
</main>
<script>
    function toggleDrawer() {
        const drawer = document.getElementById('sideDrawer');
        drawer.classList.toggle('collapsed');
    }

    function getThemePreference(name) {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return match ? match[2] : null;
    }

    window.addEventListener('pageshow', function(event) {
        if (event.persisted) window.location.reload();
    });

    window.addEventListener('DOMContentLoaded', () => {
        const body = document.body;
        const theme = getThemePreference('theme');
        if (theme === 'light') body.classList.add('light-mode');
        else if (theme === 'dark') body.classList.add('dark-mode');

        loadTips();
    });
    
    // Chart objects to track and update
    let netWorthChart, incomeChart, expensesPieChart, monthlyExpensesChart;
    
    document.addEventListener("DOMContentLoaded", function() {
        function getInt(field) {
            return field && field.integerValue ? parseInt(field.integerValue) : 0;
        }
        
        function getMap(mapField) {
            return mapField && mapField.mapValue && mapField.mapValue.fields ? mapField.mapValue.fields : {};
        }
        
        function getArray(arrayField) {
            return arrayField && arrayField.arrayValue && arrayField.arrayValue.values ? arrayField.arrayValue.values : [];
        }
        
        fetch('/api/getData')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                var fields = data.fields;
                var netWorth = getInt(fields.netWorth);
                document.getElementById("netWorthDisplay").textContent = "$" + netWorth.toLocaleString();
                
                var totalIncome = getInt(fields.totalIncome);
                document.getElementById("totalIncomeDisplay").textContent = "$" + totalIncome.toLocaleString();
                
                var totalExpenses = getInt(fields.totalExpenses);
                document.getElementById("totalExpensesDisplay").textContent = "$" + totalExpenses.toLocaleString();
                
                var billsDue = getInt(fields.billsDue);
                document.getElementById("billRemindersDisplay").innerHTML = "<h1>" + billsDue + "</h1>";
                
                var monthlyExpensesArr = getArray(fields.monthlyExpenses).map(function(item) {
                    return getInt(item);
                });
                
                if (monthlyExpensesArr.length === 0) {
                    monthlyExpensesArr = Array(12).fill(0);
                }
                
                // Create modern charts with Chart.js
                createNetWorthChart(data.fields);
                createIncomeChart(data.fields);
                createExpensePieChart(data.fields);
                createMonthlyExpensesChart(monthlyExpensesArr);
            })
            .catch(function(err) {
                console.error("Error fetching dashboard data:", err);
                // Show error message on dashboard
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.innerHTML = "<p style='text-align:center;color:#ff6b6b;'>Unable to load chart data</p>";
                });
            });
            
        // Setup event listener for the add goal button
        document.getElementById('addGoalBtn').addEventListener('click', function() {
            // Just show an alert for now - we'll implement this fully later
            alert("This feature will be implemented soon!");
            // In reality, this would open a modal to add a new financial goal
        });
    });
    
    // Create Net Worth Chart
    function createNetWorthChart(fields) {
        const ctx = document.getElementById('netWorthChart').getContext('2d');
        
        try {
            // Try to parse the netWorthBreakdown from string to object
            let breakdown = { cash: 0, equity: 0, investments: 0 };
            if (fields.netWorthBreakdown && fields.netWorthBreakdown.stringValue) {
                try {
                    breakdown = JSON.parse(fields.netWorthBreakdown.stringValue);
                } catch (e) {
                    console.warn("Couldn't parse netWorthBreakdown, using defaults");
                }
            }
            
            // If we have no data yet, insert some sample data to make the chart look good
            if (Object.values(breakdown).every(val => val === 0)) {
                breakdown = { cash: 5000, equity: 120000, investments: 45000 };
            }
            
            // Destroy previous chart if it exists
            if (netWorthChart) {
                netWorthChart.destroy();
            }
            
            // Create new chart
            netWorthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(breakdown).map(k => k.charAt(0).toUpperCase() + k.slice(1)),
                    datasets: [{
                        label: 'Value ($)',
                        data: Object.values(breakdown),
                        backgroundColor: [
                            'rgba(50, 205, 50, 0.7)',  // cash - green
                            'rgba(30, 144, 255, 0.7)', // equity - blue
                            'rgba(255, 140, 0, 0.7)'   // investments - orange
                        ],
                        borderColor: [
                            'rgb(50, 205, 50)',
                            'rgb(30, 144, 255)',
                            'rgb(255, 140, 0)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.raw.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        } catch (err) {
            console.error("Error creating net worth chart:", err);
        }
    }
    
    // Create Income Chart
    function createIncomeChart(fields) {
        const ctx = document.getElementById('incomeChart').getContext('2d');
        
        try {
            // Try to parse income breakdown
            let incomeBreakdown = { salary: 0, bonus: 0, other: 0 };
            if (fields.totalIncomeBreakdown && fields.totalIncomeBreakdown.stringValue) {
                try {
                    incomeBreakdown = JSON.parse(fields.totalIncomeBreakdown.stringValue);
                } catch (e) {
                    console.warn("Couldn't parse incomeBreakdown, using defaults");
                }
            }
            
            // If we have no data yet, insert some sample data
            if (Object.values(incomeBreakdown).every(val => val === 0)) {
                incomeBreakdown = { salary: 60000, bonus: 5000, other: 2000 };
            }
            
            // Destroy previous chart if it exists
            if (incomeChart) {
                incomeChart.destroy();
            }
            
            // Create new doughnut chart
            incomeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(incomeBreakdown).map(k => k.charAt(0).toUpperCase() + k.slice(1)),
                    datasets: [{
                        data: Object.values(incomeBreakdown),
                        backgroundColor: [
                            'rgba(255, 215, 0, 0.7)',   // salary - gold
                            'rgba(255, 105, 180, 0.7)', // bonus - pink
                            'rgba(138, 43, 226, 0.7)'   // other - purple
                        ],
                        borderColor: [
                            'rgb(255, 215, 0)',
                            'rgb(255, 105, 180)',
                            'rgb(138, 43, 226)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        } catch (err) {
            console.error("Error creating income chart:", err);
        }
    }
    
    // Create Expense Pie Chart
    function createExpensePieChart(fields) {
        const ctx = document.getElementById('expensesPieChart').getContext('2d');
        
        try {
            // For now we'll use sample category data, later we can pull real categories from expenses
            const expenseCategories = {
                'Housing': 1200,
                'Food': 450,
                'Transportation': 350,
                'Entertainment': 200,
                'Utilities': 180
            };
            
            // Destroy previous chart if it exists
            if (expensesPieChart) {
                expensesPieChart.destroy();
            }
            
            // Create new pie chart
            expensesPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(expenseCategories),
                    datasets: [{
                        data: Object.values(expenseCategories),
                        backgroundColor: [
                            'rgba(255, 140, 0, 0.7)',   // housing - orange
                            'rgba(255, 69, 0, 0.7)',    // food - red-orange
                            'rgba(30, 144, 255, 0.7)',  // transportation - blue
                            'rgba(138, 43, 226, 0.7)',  // entertainment - purple
                            'rgba(50, 205, 50, 0.7)'    // utilities - green
                        ],
                        borderColor: [
                            'rgb(255, 140, 0)',
                            'rgb(255, 69, 0)',
                            'rgb(30, 144, 255)',
                            'rgb(138, 43, 226)',
                            'rgb(50, 205, 50)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        } catch (err) {
            console.error("Error creating expense pie chart:", err);
        }
    }
    
    // Create Monthly Expenses Chart
    function createMonthlyExpensesChart(monthlyExpensesArr) {
        const ctx = document.getElementById('monthlyExpensesChart').getContext('2d');
        
        try {
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            // Destroy previous chart if it exists
            if (monthlyExpensesChart) {
                monthlyExpensesChart.destroy();
            }
            
            // Create new line chart
            monthlyExpensesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: [{
                        label: 'Monthly Expenses',
                        data: monthlyExpensesArr,
                        backgroundColor: 'rgba(255, 140, 0, 0.2)',
                        borderColor: 'rgb(255, 140, 0)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: 'rgb(255, 140, 0)',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.raw.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        } catch (err) {
            console.error("Error creating monthly expenses chart:", err);
        }
    }
</script>
</body>
</html>
