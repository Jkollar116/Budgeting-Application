<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CashClimb Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <!-- Add Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Dashboard specific styles */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .card {
            background: #3E1F5B;
            border-radius: 12px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .card h2 {
            margin-top: 0;
            color: #FF8C00;
            font-size: 1.5em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h2 i {
            font-size: 1.2em;
        }
        
        /* Chart container */
        .chart-container {
            position: relative;
            height: 220px;
            width: 100%;
        }
        
        /* Progress bar styles */
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: #FF8C00;
            border-radius: 10px;
        }
        
        .goal-item {
            background: rgba(62, 31, 91, 0.5);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        
        .btn-add-goal {
            background: #FF8C00;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
        }
        
        .btn-add-goal:hover {
            background: #ff9d2d;
        }
        
        /* Responsive grid */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="logo">CashClimb</div>
    <nav>
        <ul>
            <li><a href="home.html">Dashboard</a></li>
            <li><a href="crypto.html">Crypto</a></li>
            <li><a href="chat.html">Chat</a></li>
            <li><a href="/logout">Log Out</a></li>
        </ul>
    </nav>
</header>
<button class="drawer-toggle" onclick="toggleDrawer()">â˜°</button>
<nav class="drawer" id="sideDrawer">
    <ul>
        <li><a href="home.html">Dashboard</a></li>
        <li><a href="budgeting.html">Budgeting</a></li>
        <li><a href="expenses.html">Expenses</a></li>
        <li><a href="income.html">Income</a></li>
        <li><a href="tax.html">Tax</a></li>
        <li><a href="crypto.html">Crypto</a></li>
        <li><a href="stocks.html">Stocks</a></li>
        <li><a href="chat.html">Chat</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="settings.html">Settings</a></li>
        <li><a href="/logout">Log Out</a></li>
        <li><a href="bills.html">Bills Page</a></li>
        <li><a href="leaderboard.html">Leaderboard</a></li>
    </ul>
</nav>
<main>
    <section class="hero">
        <div class="hero-content">
            <h1>Dashboard</h1>
            <p>Your financial overview</p>
        </div>
    </section>
    <div class="dashboard">
        <div class="card" id="netWorthCard">
            <h2>ðŸ’° Net Worth</h2>
            <p id="netWorthDisplay">$0</p>
            <div class="chart-container">
                <canvas id="netWorthChart"></canvas>
            </div>
        </div>
        
        <div class="card" id="incomeCard">
            <h2>ðŸ’µ Total Income</h2>
            <p id="totalIncomeDisplay">$0</p>
            <div class="chart-container">
                <canvas id="incomeChart"></canvas>
            </div>
        </div>
        
        <div class="card" id="expensesCard">
            <h2>ðŸ“Š Total Expenses</h2>
            <p id="totalExpensesDisplay">$0</p>
            <div class="chart-container">
                <canvas id="expensesPieChart"></canvas>
            </div>
        </div>
        
        <div class="card" id="billsCard">
            <h2>ðŸ“… Bills Due</h2>
            <div id="billRemindersDisplay"><h1>0</h1></div>
        </div>
        
        <div class="card" id="chartCard">
            <h2>ðŸ“ˆ Monthly Expenses</h2>
            <div class="chart-container">
                <canvas id="monthlyExpensesChart"></canvas>
            </div>
        </div>
        
        <div class="card" id="goalsCard">
            <h2>ðŸŽ¯ Financial Goals</h2>
            <div id="goals-container">
                <div class="goal-item">
                    <p>Emergency Fund $2,500 / $5,000</p>
                    <div class="progress-bar">
                        <div class="progress" style="width: 50%"></div>
                    </div>
                </div>
                <div class="goal-item">
                    <p>Vacation Savings $800 / $2,000</p>
                    <div class="progress-bar">
                        <div class="progress" style="width: 40%"></div>
                    </div>
                </div>
                <button class="btn-add-goal" id="add-goal-btn">Add New Goal</button>
            </div>
        </div>
    </div>
</main>
<script>
    function toggleDrawer() {
        const drawer = document.getElementById('sideDrawer');
        drawer.classList.toggle('collapsed');
    }
    
    // Chart objects to track and update
    let netWorthChart, incomeChart, expensesPieChart, monthlyExpensesChart;
    
    function getThemePreference(name) {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        if (!match) return null;
        return match[2];
    }
    
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) window.location.reload();
    });
    
    window.addEventListener('DOMContentLoaded', () => {
        // Apply theme
        const savedTheme = getThemePreference('theme');
        const body = document.body;
        if (savedTheme === 'light') {
            body.classList.add('light-mode');
        } else if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
        }
        if (savedTheme) {
            const input = document.querySelector(`input[name="theme"][value="${savedTheme}"]`);
            if (input) input.checked = true;
        }
        
        // Add Goal Button Functionality
        const addGoalBtn = document.getElementById('add-goal-btn');
        if (addGoalBtn) {
            addGoalBtn.addEventListener('click', function() {
                showAddGoalForm();
            });
        }
    });
    
    function showAddGoalForm() {
        // Create modal for adding a new goal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';
        
        // Create form container
        const formContainer = document.createElement('div');
        formContainer.className = 'form-container';
        formContainer.style.backgroundColor = '#3E1F5B';
        formContainer.style.padding = '20px';
        formContainer.style.borderRadius = '10px';
        formContainer.style.width = '90%';
        formContainer.style.maxWidth = '500px';
        
        // Create form content
        formContainer.innerHTML = `
            <h3 style="color: #FF8C00; margin-top: 0;">Add New Financial Goal</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: white;">Goal Name</label>
                <input type="text" id="goal-name" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: white;">Target Amount ($)</label>
                <input type="number" id="goal-amount" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;" min="1">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: white;">Current Progress ($)</label>
                <input type="number" id="goal-progress" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;" min="0">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button id="cancel-goal" style="padding: 8px 15px; border-radius: 5px; border: none; background-color: #6c757d; color: white; cursor: pointer;">Cancel</button>
                <button id="save-goal" style="padding: 8px 15px; border-radius: 5px; border: none; background-color: #FF8C00; color: white; cursor: pointer;">Save Goal</button>
            </div>
        `;
        
        modal.appendChild(formContainer);
        document.body.appendChild(modal);
        
        // Add event listeners to buttons
        document.getElementById('cancel-goal').addEventListener('click', function() {
            document.body.removeChild(modal);
        });
        
        document.getElementById('save-goal').addEventListener('click', function() {
            const name = document.getElementById('goal-name').value;
            const amount = document.getElementById('goal-amount').value;
            const progress = document.getElementById('goal-progress').value;
            
            if (!name || !amount) {
                alert('Please fill out all required fields');
                return;
            }
            
            addGoalToList(name, parseFloat(progress) || 0, parseFloat(amount));
            document.body.removeChild(modal);
        });
    }
    
    function addGoalToList(name, progress, target) {
        const goalsContainer = document.getElementById('goals-container');
        const percent = Math.min(100, Math.round((progress / target) * 100));
        
        const goalItem = document.createElement('div');
        goalItem.className = 'goal-item';
        goalItem.innerHTML = `
            <p>${name} $${progress.toFixed(2)} / $${target.toFixed(2)}</p>
            <div class="progress-bar">
                <div class="progress" style="width: ${percent}%"></div>
            </div>
        `;
        
        // Insert the new goal before the add button
        const addButton = document.getElementById('add-goal-btn');
        goalsContainer.insertBefore(goalItem, addButton);
    }
    
    document.addEventListener("DOMContentLoaded", function() {
        function getInt(field) {
            return field && field.integerValue ? parseInt(field.integerValue) : 0;
        }
        
        function getArray(arrayField) {
            return arrayField && arrayField.arrayValue && arrayField.arrayValue.values ? arrayField.arrayValue.values : [];
        }
        
        fetch('/api/getData')
            .then(response => response.json())
            .then(data => {
                const fields = data.fields || {};
                
                const netWorth = getInt(fields.netWorth);
                document.getElementById("netWorthDisplay").textContent = "$" + netWorth.toLocaleString();
                
                const totalIncome = getInt(fields.totalIncome);
                document.getElementById("totalIncomeDisplay").textContent = "$" + totalIncome.toLocaleString();
                
                const totalExpenses = getInt(fields.totalExpenses);
                document.getElementById("totalExpensesDisplay").textContent = "$" + totalExpenses.toLocaleString();
                
                const billsDue = getInt(fields.billsDue);
                document.getElementById("billRemindersDisplay").innerHTML = "<h1>" + billsDue + "</h1>";
                
                const monthlyExpensesArr = getArray(fields.monthlyExpenses).map(item => getInt(item));
                const monthlyIncomesArr = getArray(fields.monthlyIncomes).map(item => getInt(item));
                
                // Create modern charts with Chart.js
                createNetWorthChart(fields);
                createIncomeChart(fields);
                createExpensePieChart(fields);
                createMonthlyExpensesChart(monthlyExpensesArr);
            })
            .catch(err => {
                console.error("Error fetching dashboard data:", err);
                // Show error message on dashboard
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.innerHTML = "<p style='text-align:center;color:#ff6b6b;'>Unable to load chart data</p>";
                });
            });
    });
    
    // Create Net Worth Chart
    function createNetWorthChart(fields) {
        const ctx = document.getElementById('netWorthChart').getContext('2d');
        
        try {
            // Try to parse the netWorthBreakdown from string to object
            let breakdown = { cash: 5000, equity: 120000, investments: 45000 };
            
            // Destroy previous chart if it exists
            if (netWorthChart) {
                netWorthChart.destroy();
            }
            
            // Create new chart
            netWorthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(breakdown).map(k => k.charAt(0).toUpperCase() + k.slice(1)),
                    datasets: [{
                        label: 'Value ($)',
                        data: Object.values(breakdown),
                        backgroundColor: [
                            'rgba(50, 205, 50, 0.7)',  // cash - green
                            'rgba(30, 144, 255, 0.7)', // equity - blue
                            'rgba(255, 140, 0, 0.7)'   // investments - orange
                        ],
                        borderColor: [
                            'rgb(50, 205, 50)',
                            'rgb(30, 144, 255)',
                            'rgb(255, 140, 0)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.raw.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        } catch (err) {
            console.error("Error creating net worth chart:", err);
        }
    }
    
    // Create Income Chart
    function createIncomeChart(fields) {
        const ctx = document.getElementById('incomeChart').getContext('2d');
        
        try {
            // Sample income breakdown
            let incomeBreakdown = { salary: 60000, bonus: 5000, other: 2000 };
            
            // Destroy previous chart if it exists
            if (incomeChart) {
                incomeChart.destroy();
            }
            
            // Create new doughnut chart
            incomeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(incomeBreakdown).map(k => k.charAt(0).toUpperCase() + k.slice(1)),
                    datasets: [{
                        data: Object.values(incomeBreakdown),
                        backgroundColor: [
                            'rgba(255, 215, 0, 0.7)',   // salary - gold
                            'rgba(255, 105, 180, 0.7)', // bonus - pink
                            'rgba(138, 43, 226, 0.7)'   // other - purple
                        ],
                        borderColor: [
                            'rgb(255, 215, 0)',
                            'rgb(255, 105, 180)',
                            'rgb(138, 43, 226)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        } catch (err) {
            console.error("Error creating income chart:", err);
        }
    }
    
    // Create Expense Pie Chart
    function createExpensePieChart(fields) {
        const ctx = document.getElementById('expensesPieChart').getContext('2d');
        
        try {
            // Sample category data
            const expenseCategories = {
                'Housing': 1200,
                'Food': 450,
                'Transportation': 350,
                'Entertainment': 200,
                'Utilities': 180
            };
            
            // Destroy previous chart if it exists
            if (expensesPieChart) {
                expensesPieChart.destroy();
            }
            
            // Create new pie chart
            expensesPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(expenseCategories),
                    datasets: [{
                        data: Object.values(expenseCategories),
                        backgroundColor: [
                            'rgba(255, 140, 0, 0.7)',   // housing - orange
                            'rgba(255, 69, 0, 0.7)',    // food - red-orange
                            'rgba(30, 144, 255, 0.7)',  // transportation - blue
                            'rgba(138, 43, 226, 0.7)',  // entertainment - purple
                            'rgba(50, 205, 50, 0.7)'    // utilities - green
                        ],
                        borderColor: [
                            'rgb(255, 140, 0)',
                            'rgb(255, 69, 0)',
                            'rgb(30, 144, 255)',
                            'rgb(138, 43, 226)',
                            'rgb(50, 205, 50)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        } catch (err) {
            console.error("Error creating expense pie chart:", err);
        }
    }
    
    // Create Monthly Expenses Chart
    function createMonthlyExpensesChart(monthlyExpensesArr) {
        const ctx = document.getElementById('monthlyExpensesChart').getContext('2d');
        
        try {
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            // Ensure we have 12 months of data
            if (monthlyExpensesArr.length < 12) {
                monthlyExpensesArr = Array(12).fill(0).map((v, i) => 
                    i < monthlyExpensesArr.length ? monthlyExpensesArr[i] : 0
                );
            }
            
            // Destroy previous chart if it exists
            if (monthlyExpensesChart) {
                monthlyExpensesChart.destroy();
            }
            
            // Create new line chart
            monthlyExpensesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: [{
                        label: 'Monthly Expenses',
                        data: monthlyExpensesArr,
                        backgroundColor: 'rgba(255, 140, 0, 0.2)',
                        borderColor: 'rgb(255, 140, 0)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: 'rgb(255, 140, 0)',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.raw.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        } catch (err) {
            console.error("Error creating monthly expenses chart:", err);
        }
    }
</script>
</body>
</html>
