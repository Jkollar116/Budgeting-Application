<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BudgetApp Home</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
    <div class="logo">CashClimb</div>
    <nav>
        <ul class="nav-items">
            <li class="profile-link-container">
                <a href="profile.html">
                    <img id="navProfileImage" class="nav-profile-img" alt="Profile" />
                </a>
                <a href="profile.html" class="active">Profile</a>
            </li>
        </ul>
    </nav>
</header>
<button class="drawer-toggle" onclick="toggleDrawer()">â˜°</button>
<nav class="drawer" id="sideDrawer">
    <ul>
        <li><a href="home.html">Dashboard</a></li>
        <li><a href="assetsLiabilities.html" class="active">Assets &amp; Liabilities</a></li>
        <li><a href="bills.html">Bills Page</a></li>
        <li><a href="budget.html">Budget</a></li>
        <li><a href="chat.html">Chat</a></li>
        <li><a href="crypto.html">Crypto</a></li>
        <li><a href="currency.html">Currency</a></li>
        <li><a href="expenses.html">Expenses</a></li>
        <li><a href="income.html">Income</a></li>
        <li><a href="leaderboard.html">Leaderboard</a></li>
        <li><a href="loanCalculator.html">Loan Calculator</a></li>
        <li><a href="netWorth.html">Net Worth</a></li>
        <li><a href="tips.html">Tips</a></li>
        <li><a href="savedTips.html">Saved Tips</a></li>
        <li><a href="stocks.html">Stocks</a></li>
        <li><a href="tax.html">Tax</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="settings.html">Settings</a></li>
        <li><a href="/logout">Logout</a></li>
    </ul>
</nav>
<main>
    <section class="hero">
        <div class="hero-content">
            <h1>Dashboard</h1>
            <p>Your financial overview</p>
        </div>
    </section>
    <div class="dashboard">
        <div class="card" id="netWorthCard">
            <h2>Net Worth</h2>
            <p id="netWorthDisplay"></p>
            <div id="netWorthChart"></div>
        </div>
        <div class="card" id="incomeCard">
            <h2>Total Income</h2>
            <p id="totalIncomeDisplay"></p>
            <div id="incomeChart"></div>
        </div>
        <div class="card" id="expensesCard">
            <h2>Total Expenses</h2>
            <p id="totalExpensesDisplay"></p>
            <div id="expensesPieChart"></div>
        </div>
        <div class="card" id="billsCard">
            <h2>Bills Due</h2>
            <div id="billRemindersDisplay"></div>
        </div>
        <div class="card" id="chartCard">
            <h2>Monthly Expenses</h2>
            <div id="chartContainer"></div>
        </div>
    </div>
</main>
<script>
    function toggleDrawer() {
        document.getElementById('sideDrawer').classList.toggle('collapsed');
    }

    function getThemePreference(name) {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return match ? match[2] : null;
    }

    window.addEventListener('pageshow', function(event) {
        if (event.persisted) window.location.reload();
    });

    window.addEventListener('DOMContentLoaded', () => {
        const savedTheme = getThemePreference('theme');
        const body = document.body;
        if (savedTheme === 'light') {
            body.classList.add('light-mode');
        } else if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
        }
        if (savedTheme) {
            const input = document.querySelector(`input[name="theme"][value="${savedTheme}"]`);
            if (input) input.checked = true;
        }
    });

    window.addEventListener('DOMContentLoaded', () => {
        const navImg = document.getElementById('navProfileImage');
        fetch('/api/profile', { method: 'GET', headers: { 'Content-Type': 'application/json' } })
            .then(res => {
                if (!res.ok) throw new Error('Profile fetch failed');
                return res.json();
            })
            .then(data => {
                const fields = data.fields || {};
                if (fields.profileImage && fields.profileImage.stringValue) {
                    navImg.src = fields.profileImage.stringValue;
                } else {
                    throw new Error('No image in profile data');
                }
            })
            .catch(() => {
                navImg.src = 'default-avatar.png';
            });
    });

    document.addEventListener('DOMContentLoaded', function() {
        function getInt(field) {
            if (!field) return 0;
            if (field.integerValue) return parseInt(field.integerValue, 10);
            if (field.doubleValue) return Math.floor(parseFloat(field.doubleValue));
            return 0;
        }
        function getArray(arrayField) {
            return (arrayField && arrayField.arrayValue && arrayField.arrayValue.values) || [];
        }

        fetch('/api/getData')
            .then(res => {
                if (!res.ok) {
                    console.error(`getData failed with status ${res.status}`);
                    return {};
                }
                return res.json();
            })
            .then(data => {
                const fields = data.fields || {};

                const netWorth = getInt(fields.netWorth);
                document.getElementById('netWorthDisplay').textContent = '$' + netWorth;

                const totalIncome = getInt(fields.totalIncome);
                document.getElementById('totalIncomeDisplay').textContent = '$' + totalIncome;

                const totalExpenses = getInt(fields.totalExpenses);
                document.getElementById('totalExpensesDisplay').textContent = '$' + totalExpenses;

                const billsDue = getInt(fields.billsDue);
                document.getElementById('billRemindersDisplay').innerHTML = '<h1>' + billsDue + '</h1>';

                let monthlyExpensesArr = getArray(fields.monthlyExpenses).map(getInt);
                if (monthlyExpensesArr.length < 12) monthlyExpensesArr = Array(12).fill(0);
                buildBarChart(monthlyExpensesArr);
                buildPieChartExpenses(monthlyExpensesArr);

                let monthlyIncomesArr = getArray(fields.monthlyIncomes).map(getInt);
                if (monthlyIncomesArr.length < 12) monthlyIncomesArr = Array(12).fill(0);
                buildPieChartIncome(monthlyIncomesArr);
            })
            .catch(e => {
                console.error('Error fetching dashboard data:', e);
            });
    });

    function buildBarChart(monthlyExpensesArr) {
        const svgNS = 'http://www.w3.org/2000/svg';
        const barContainer = document.getElementById('chartContainer');
        const containerWidth = barContainer.clientWidth;
        const chartWidth = containerWidth < 500 ? 500 : containerWidth;
        const chartHeight = 300;
        const barWidth = chartWidth / monthlyExpensesArr.length;
        let maxExpense = Math.max(...monthlyExpensesArr);
        if (maxExpense === 0) maxExpense = 1;

        const barSvg = document.createElementNS(svgNS, 'svg');
        barSvg.setAttribute('width', '100%');
        barSvg.setAttribute('viewBox', `0 0 ${chartWidth} ${chartHeight}`);

        monthlyExpensesArr.forEach((expense, i) => {
            let barHeight = (expense / maxExpense) * (chartHeight - 40);
            barHeight = Math.max(0, Math.min(barHeight, chartHeight - 40));
            const x = i * barWidth;
            const y = chartHeight - barHeight;
            const rect = document.createElementNS(svgNS, 'rect');
            rect.setAttribute('x', x);
            rect.setAttribute('y', y);
            rect.setAttribute('width', barWidth - 4);
            rect.setAttribute('height', barHeight);
            rect.setAttribute('fill', '#FF8C00');
            barSvg.appendChild(rect);

            const label = document.createElementNS(svgNS, 'text');
            label.setAttribute('x', x + (barWidth - 4) / 2);
            label.setAttribute('y', chartHeight - 5);
            label.setAttribute('fill', '#000');
            label.setAttribute('font-size', '10');
            label.setAttribute('text-anchor', 'middle');
            label.textContent = (i + 1);
            barSvg.appendChild(label);
        });

        barContainer.innerHTML = '';
        barContainer.appendChild(barSvg);
    }

    function buildPieChartExpenses(monthlyExpensesArr) {
        const svgNS = 'http://www.w3.org/2000/svg';
        const container = document.getElementById('expensesPieChart');
        container.innerHTML = '';
        const total = monthlyExpensesArr.reduce((a, b) => a + b, 0);
        if (total <= 0) {
            container.innerHTML = "<p style='padding:10px;text-align:center;'>No expense data</p>";
            return;
        }

        const size = 200;
        const cx = size / 2, cy = size / 2, r = cx - 10;
        const svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('width', size);
        svg.setAttribute('height', size);

        const quarters = [0, 0, 0, 0];
        monthlyExpensesArr.forEach((v, i) => quarters[Math.floor(i / 3)] += v);
        const labels = ['Q1', 'Q2', 'Q3', 'Q4'];
        const colors = ['#FF8C00', '#FF4500', '#1E90FF', '#32CD32'];

        let startAngle = 0;
        const totalAll = quarters.reduce((a, b) => a + b, 0);

        quarters.forEach((v, i) => {
            if (v <= 0) return;
            const sliceAngle = (v / totalAll) * 2 * Math.PI;
            const endAngle = startAngle + sliceAngle;
            const x1 = cx + r * Math.cos(startAngle);
            const y1 = cy + r * Math.sin(startAngle);
            const x2 = cx + r * Math.cos(endAngle);
            const y2 = cy + r * Math.sin(endAngle);
            const largeArc = sliceAngle > Math.PI ? 1 : 0;
            const d = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2} Z`;

            const path = document.createElementNS(svgNS, 'path');
            path.setAttribute('d', d);
            path.setAttribute('fill', colors[i % colors.length]);
            svg.appendChild(path);

            const midAngle = startAngle + sliceAngle / 2;
            const labelX = cx + (r / 2) * Math.cos(midAngle);
            const labelY = cy + (r / 2) * Math.sin(midAngle);
            const text = document.createElementNS(svgNS, 'text');
            text.setAttribute('x', labelX);
            text.setAttribute('y', labelY);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', '#fff');
            text.setAttribute('font-size', '10');
            text.textContent = `${labels[i]}(${v})`;
            svg.appendChild(text);

            startAngle = endAngle;
        });

        container.appendChild(svg);
    }

    function buildPieChartIncome(monthlyIncomesArr) {
        const svgNS = 'http://www.w3.org/2000/svg';
        const container = document.getElementById('incomeChart');
        container.innerHTML = '';
        const sum = monthlyIncomesArr.reduce((a, b) => a + b, 0);
        if (sum <= 0) {
            container.innerHTML = "<p style='padding:10px;text-align:center;'>No income data</p>";
            return;
        }

        const size = 200;
        const cx = size / 2, cy = size / 2, r = cx - 10;
        const svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('width', size);
        svg.setAttribute('height', size);

        const colors = ['#FFD700','#FF69B4','#8A2BE2','#20B2AA','#F08080','#DEB887','#87CEEB','#FFA500','#C71585','#ADFF2F','#00FA9A','#FF6347'];
        let startAngle = 0;

        monthlyIncomesArr.forEach((v, i) => {
            if (v <= 0) return;
            const sliceAngle = (v / sum) * 2 * Math.PI;
            const endAngle = startAngle + sliceAngle;
            const x1 = cx + r * Math.cos(startAngle);
            const y1 = cy + r * Math.sin(startAngle);
            const x2 = cx + r * Math.cos(endAngle);
            const y2 = cy + r * Math.sin(endAngle);
            const largeArc = sliceAngle > Math.PI ? 1 : 0;
            const d = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2} Z`;

            const path = document.createElementNS(svgNS, 'path');
            path.setAttribute('d', d);
            path.setAttribute('fill', colors[i % colors.length]);
            svg.appendChild(path);

            const midAngle = startAngle + sliceAngle / 2;
            const labelX = cx + (r / 2) * Math.cos(midAngle);
            const labelY = cy + (r / 2) * Math.sin(midAngle);
            const text = document.createElementNS(svgNS, 'text');
            text.setAttribute('x', labelX);
            text.setAttribute('y', labelY);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', '#fff');
            text.setAttribute('font-size', '10');
            text.textContent = (i + 1);
            svg.appendChild(text);

            startAngle = endAngle;
        });

        container.appendChild(svg);
    }
</script>
</body>
</html>
