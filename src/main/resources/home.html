<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CashClimb Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Dashboard specific styles */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .card {
            background: #3E1F5B;
            border-radius: 12px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .card h2 {
            margin-top: 0;
            color: #FF8C00;
            font-size: 1.5em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h2 i {
            font-size: 1.2em;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: #FF8C00;
            border-radius: 10px;
        }
        
        .goal-item {
            background: rgba(62, 31, 91, 0.5);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        
        .btn-add-goal {
            background: #FF8C00;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
        }
        
        .btn-add-goal:hover {
            background: #ff9d2d;
        }
        
        /* Responsive grid */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="logo">CashClimb</div>
    <nav>
        <ul>
            <li><a href="home.html">Dashboard</a></li>
            <li><a href="crypto.html">Crypto</a></li>
            <li><a href="chat.html">Chat</a></li>
            <li><a href="/logout">Log Out</a></li>
        </ul>
    </nav>
</header>
<button class="drawer-toggle" onclick="toggleDrawer()">â˜°</button>
<nav class="drawer" id="sideDrawer">
    <ul>
        <li><a href="home.html">Dashboard</a></li>
        <li><a href="expenses.html">Expenses</a></li>
        <li><a href="income.html">Income</a></li>
        <li><a href="tax.html">Tax</a></li>
        <li><a href="crypto.html">Crypto</a></li>
        <li><a href="stocks.html">Stocks</a></li>
        <li><a href="chat.html">Chat</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="settings.html">Settings</a></li>
        <li><a href="/logout">Log Out</a></li>
        <li><a href="bills.html">Bills Page</a></li>
        <li><a href="leaderboard.html">Leaderboard</a></li>
    </ul>
</nav>
<main>
    <div class="dashboard">
        <div class="card" id="netWorthCard">
            <h2>ðŸ’° Net Worth</h2>
            <p id="netWorthDisplay">$0</p>
            <div id="netWorthChart"></div>
        </div>
        
        <div class="card" id="incomeCard">
            <h2>ðŸ’µ Total Income</h2>
            <p id="totalIncomeDisplay">$0</p>
            <div id="incomeChart"></div>
        </div>
        
        <div class="card" id="expensesCard">
            <h2>ðŸ“Š Total Expenses</h2>
            <p id="totalExpensesDisplay">$0</p>
            <div id="expensesPieChart"></div>
        </div>
        
        <div class="card" id="billsCard">
            <h2>ðŸ“… Bills Due</h2>
            <div id="billRemindersDisplay"><h1>0</h1></div>
        </div>
        
        <div class="card" id="chartCard">
            <h2>ðŸ“ˆ Monthly Expenses</h2>
            <div id="chartContainer"></div>
        </div>
        
        <div class="card" id="goalsCard">
            <h2>ðŸŽ¯ Financial Goals</h2>
            <div id="goals-container">
                <div class="goal-item">
                    <p>Emergency Fund $2,500 / $5,000</p>
                    <div class="progress-bar">
                        <div class="progress" style="width: 50%"></div>
                    </div>
                </div>
                <div class="goal-item">
                    <p>Vacation Savings $800 / $2,000</p>
                    <div class="progress-bar">
                        <div class="progress" style="width: 40%"></div>
                    </div>
                </div>
                <button class="btn-add-goal" id="add-goal-btn">Add New Goal</button>
            </div>
        </div>
    </div>
</main>
<script>
    function toggleDrawer() {
        const drawer = document.getElementById('sideDrawer');
        drawer.classList.toggle('collapsed');
    }
    function getThemePreference(name) {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        if (!match) return null;
        return match[2];
    }
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) window.location.reload();
    });
    window.addEventListener('DOMContentLoaded', () => {
        const savedTheme = getThemePreference('theme');
        const body = document.body;
        if (savedTheme === 'light') {
            body.classList.add('light-mode');
        } else if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
        }
        if (savedTheme) {
            const input = document.querySelector(`input[name="theme"][value="${savedTheme}"]`);
            if (input) input.checked = true;
        }
        
        // Add Goal Button Functionality
        const addGoalBtn = document.getElementById('add-goal-btn');
        if (addGoalBtn) {
            addGoalBtn.addEventListener('click', function() {
                showAddGoalForm();
            });
        }
    });
    
    function showAddGoalForm() {
        // Create modal for adding a new goal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';
        
        // Create form container
        const formContainer = document.createElement('div');
        formContainer.className = 'form-container';
        formContainer.style.backgroundColor = '#3E1F5B';
        formContainer.style.padding = '20px';
        formContainer.style.borderRadius = '10px';
        formContainer.style.width = '90%';
        formContainer.style.maxWidth = '500px';
        
        // Create form content
        formContainer.innerHTML = `
            <h3 style="color: #FF8C00; margin-top: 0;">Add New Financial Goal</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: white;">Goal Name</label>
                <input type="text" id="goal-name" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: white;">Target Amount ($)</label>
                <input type="number" id="goal-amount" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;" min="1">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: white;">Current Progress ($)</label>
                <input type="number" id="goal-progress" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;" min="0">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button id="cancel-goal" style="padding: 8px 15px; border-radius: 5px; border: none; background-color: #6c757d; color: white; cursor: pointer;">Cancel</button>
                <button id="save-goal" style="padding: 8px 15px; border-radius: 5px; border: none; background-color: #FF8C00; color: white; cursor: pointer;">Save Goal</button>
            </div>
        `;
        
        modal.appendChild(formContainer);
        document.body.appendChild(modal);
        
        // Add event listeners to buttons
        document.getElementById('cancel-goal').addEventListener('click', function() {
            document.body.removeChild(modal);
        });
        
        document.getElementById('save-goal').addEventListener('click', function() {
            const name = document.getElementById('goal-name').value;
            const amount = document.getElementById('goal-amount').value;
            const progress = document.getElementById('goal-progress').value;
            
            if (!name || !amount) {
                alert('Please fill out all required fields');
                return;
            }
            
            addGoalToList(name, parseFloat(progress) || 0, parseFloat(amount));
            document.body.removeChild(modal);
        });
    }
    
    function addGoalToList(name, progress, target) {
        const goalsContainer = document.getElementById('goals-container');
        const percent = Math.min(100, Math.round((progress / target) * 100));
        
        const goalItem = document.createElement('div');
        goalItem.className = 'goal-item';
        goalItem.innerHTML = `
            <p>${name} $${progress.toFixed(2)} / $${target.toFixed(2)}</p>
            <div class="progress-bar">
                <div class="progress" style="width: ${percent}%"></div>
            </div>
        `;
        
        // Insert the new goal before the add button
        const addButton = document.getElementById('add-goal-btn');
        goalsContainer.insertBefore(goalItem, addButton);
    }
    document.addEventListener("DOMContentLoaded", function() {
        console.log("home.html: DOMContentLoaded");

        function getInt(field) {
            // Safely parse an integer from field's integerValue or doubleValue
            if(!field) return 0;
            if(field.integerValue) return parseInt(field.integerValue);
            if(field.doubleValue) return Math.floor(parseFloat(field.doubleValue));
            return 0;
        }
        function getArray(arrayField) {
            if(arrayField && arrayField.arrayValue && arrayField.arrayValue.values) {
                return arrayField.arrayValue.values;
            }
            return [];
        }

        fetch('/api/getData')
            .then(r=>r.json())
            .then(data=>{
                console.log("home.html: data received", data);
                let fields = data.fields || {};

                let netWorth = getInt(fields.netWorth);
                document.getElementById("netWorthDisplay").textContent = "$" + netWorth;

                let totalIncome = getInt(fields.totalIncome);
                document.getElementById("totalIncomeDisplay").textContent = "" ;

                let totalExpenses = getInt(fields.totalExpenses);
                document.getElementById("totalExpensesDisplay").textContent = "$" + totalExpenses;

                let billsDue = getInt(fields.billsDue);
                document.getElementById("billRemindersDisplay").innerHTML = "<h1>"+billsDue+"</h1>";

                // monthlyExpenses
                let monthlyExpensesArr = getArray(fields.monthlyExpenses).map(getInt);
                if(monthlyExpensesArr.length < 12) {
                    monthlyExpensesArr = Array(12).fill(0);
                }
                console.log("home.html: building expense bar chart", monthlyExpensesArr);
                buildBarChart(monthlyExpensesArr);

                // build expenses pie
                buildPieChartExpenses(monthlyExpensesArr);

                // monthlyIncomes
                let monthlyIncomesArr = getArray(fields.monthlyIncomes).map(getInt);
                if(monthlyIncomesArr.length < 12) {
                    monthlyIncomesArr = Array(12).fill(0);
                }
                console.log("home.html: building income pie chart", monthlyIncomesArr);
                buildPieChartIncome(monthlyIncomesArr);
            })
            .catch(e=>{
                console.error("Error fetching dashboard data:", e);
            });
    });

    function buildBarChart(monthlyExpensesArr) {
        let barContainer = document.getElementById("chartContainer");
        let svgNS = "http://www.w3.org/2000/svg";

        let containerWidth = barContainer.clientWidth;
        let chartWidth = containerWidth < 500 ? 500 : containerWidth;
        let chartHeight = 300;
        let barWidth = chartWidth / monthlyExpensesArr.length;

        let maxExpense = Math.max(...monthlyExpensesArr);
        if(maxExpense === 0) maxExpense=1;

        let barSvg = document.createElementNS(svgNS, "svg");
        barSvg.setAttribute("width", "100%");
        barSvg.setAttribute("viewBox", `0 0 ${chartWidth} ${chartHeight}`);

        monthlyExpensesArr.forEach((expense, i)=>{
            // scale bar height
            let barHeight = (expense / maxExpense) * (chartHeight - 40);

            // clamp so it never goes negative or above chart
            barHeight = Math.max(0, barHeight);
            barHeight = Math.min(barHeight, chartHeight - 40);

            let x = i * barWidth;
            let y = chartHeight - barHeight;

            let rect = document.createElementNS(svgNS, "rect");
            rect.setAttribute("x", x);
            rect.setAttribute("y", y);
            rect.setAttribute("width", barWidth - 4);
            rect.setAttribute("height", barHeight);
            rect.setAttribute("fill", "#FF8C00");
            barSvg.appendChild(rect);

            // label
            let label = document.createElementNS(svgNS, "text");
            label.setAttribute("x", x + (barWidth - 4)/2);
            label.setAttribute("y", chartHeight - 5);
            label.setAttribute("fill", "#000");
            label.setAttribute("font-size","10");
            label.setAttribute("text-anchor","middle");
            label.textContent = (i+1);
            barSvg.appendChild(label);
        });

        barContainer.innerHTML="";
        barContainer.appendChild(barSvg);
    }

    function buildPieChartExpenses(monthlyExpensesArr){
        let expensesPieContainer = document.getElementById("expensesPieChart");
        expensesPieContainer.innerHTML="";

        if(!monthlyExpensesArr || monthlyExpensesArr.length===0){
            expensesPieContainer.innerHTML="<p style='padding:10px;text-align:center;'>No monthly expense data</p>";
            return;
        }
        let totalExpense = monthlyExpensesArr.reduce((a,b)=>a+b,0);
        if(totalExpense<=0){
            expensesPieContainer.innerHTML="<p style='padding:10px;text-align:center;'>No expense data</p>";
            return;
        }

        let svgNS="http://www.w3.org/2000/svg";
        let size=200;
        let cx=size/2, cy=size/2;
        let r=(size/2)-10;
        let svg=document.createElementNS(svgNS,"svg");
        svg.setAttribute("width", size);
        svg.setAttribute("height",size);

        let startAngle=0;
        // we'll group months in quarters, for example
        let quarters=[0,0,0,0];
        monthlyExpensesArr.forEach((val,i)=>{
            quarters[Math.floor(i/3)] += val;
        });
        let quarterLabels=["Q1","Q2","Q3","Q4"];
        let colors=["#FF8C00","#FF4500","#1E90FF","#32CD32"];
        let totalAll=quarters.reduce((a,b)=>a+b,0);

        quarters.forEach((val,i)=>{
            if(val<=0) return;
            let sliceAngle=(val/totalAll)*2*Math.PI;
            let endAngle=startAngle+sliceAngle;

            let x1=cx + r*Math.cos(startAngle);
            let y1=cy + r*Math.sin(startAngle);
            let x2=cx + r*Math.cos(endAngle);
            let y2=cy + r*Math.sin(endAngle);

            let largeArc= sliceAngle>Math.PI ? 1 : 0;
            let d=`M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2} Z`;

            let path=document.createElementNS(svgNS,"path");
            path.setAttribute("d", d);
            path.setAttribute("fill", colors[i%colors.length]);
            svg.appendChild(path);

            // label
            let midAngle=startAngle + sliceAngle/2;
            let labelX=cx + (r/2)*Math.cos(midAngle);
            let labelY=cy + (r/2)*Math.sin(midAngle);

            let text=document.createElementNS(svgNS,"text");
            text.setAttribute("x",labelX);
            text.setAttribute("y",labelY);
            text.setAttribute("text-anchor","middle");
            text.setAttribute("fill","#fff");
            text.setAttribute("font-size","10");
            text.textContent= quarterLabels[i]+"("+val+")";

            svg.appendChild(text);

            startAngle=endAngle;
        });

        expensesPieContainer.appendChild(svg);
    }

    function buildPieChartIncome(monthlyIncomesArr){
        let incomeChart=document.getElementById("incomeChart");
        incomeChart.innerHTML="";

        if(!monthlyIncomesArr || monthlyIncomesArr.length===0){
            incomeChart.innerHTML="<p style='padding:10px;text-align:center;'>No monthly income data</p>";
            return;
        }
        let sum=monthlyIncomesArr.reduce((a,b)=>a+b,0);
        if(sum<=0){
            incomeChart.innerHTML="<p style='padding:10px;text-align:center;'>No income data</p>";
            return;
        }

        let svgNS="http://www.w3.org/2000/svg";
        let size=200;
        let cx=size/2, cy=size/2;
        let r=(size/2)-10;
        let svg=document.createElementNS(svgNS,"svg");
        svg.setAttribute("width", size);
        svg.setAttribute("height", size);

        let startAngle=0;
        let colors=["#FFD700","#FF69B4","#8A2BE2","#20B2AA","#F08080","#DEB887","#87CEEB","#FFA500","#C71585","#ADFF2F","#00FA9A","#FF6347"];

        monthlyIncomesArr.forEach((val,i)=>{
            if(val<=0) return;
            let sliceAngle=(val/sum)*2*Math.PI;
            let endAngle=startAngle+sliceAngle;

            let x1=cx + r*Math.cos(startAngle);
            let y1=cy + r*Math.sin(startAngle);
            let x2=cx + r*Math.cos(endAngle);
            let y2=cy + r*Math.sin(endAngle);

            let largeArc= sliceAngle>Math.PI ? 1 : 0;
            let d=`M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2} Z`;

            let path=document.createElementNS(svgNS,"path");
            path.setAttribute("d", d);
            path.setAttribute("fill", colors[i%colors.length]);
            svg.appendChild(path);

            // label
            let midAngle=startAngle + sliceAngle/2;
            let labelX=cx + (r/2)*Math.cos(midAngle);
            let labelY=cy + (r/2)*Math.sin(midAngle);

            let text=document.createElementNS(svgNS,"text");
            text.setAttribute("x",labelX);
            text.setAttribute("y",labelY);
            text.setAttribute("text-anchor","middle");
            text.setAttribute("fill","#fff");
            text.setAttribute("font-size","10");
            text.textContent= (i+1);

            svg.appendChild(text);

            startAngle=endAngle;
        });

        incomeChart.appendChild(svg);
    }
</script>
</body>
</html>
