<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Profile Setup</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
    <div class="logo">CashClimb</div>
    <nav>
        <ul>
            <li><a href="profile.html">Profile</a></li>
        </ul>
    </nav>
</header>
<button class="drawer-toggle" onclick="toggleDrawer()">â˜°</button>
<nav class="drawer" id="sideDrawer">
    <ul>
        <li><a href="home.html">Dashboard</a></li>
        <li><a href="expenses.html">Expenses</a></li>
        <li><a href="income.html">Income</a></li>
        <li><a href="tax.html">Tax</a></li>
        <li><a href="crypto.html">Crypto</a></li>
        <li><a href="stocks.html">Stocks</a></li>
        <li><a href="chat.html">Chat</a></li>
        <li><a href="tips.html">Tips</a></li>
        <li><a href="savedTips.html">Saved Tips</a></li>
        <li><a href="savingsTips.html">Savings Tips</a></li>
        <li><a href="assetsLiabilities.html">Assets &amp; Liabilities</a></li>
        <li><a href="budget.html">Budget</a></li>
        <li><a href="bills.html">Bills</a></li>
        <li><a href="alerts.html">Alerts</a></li>
        <li><a href="profile.html" class="active">Profile</a></li>
        <li><a href="settings.html">Settings</a></li>
        <li><a href="leaderboard.html">Leaderboard</a></li>
        <li><a href="/logout">Logout</a></li>
    </ul>
</nav>
<main>
    <div class="hero">
        <div class="header-content">
            <h1>Profile Management</h1>
            <p>Manage Your Profile Below</p>
        </div>
    </div>
    <div class="profile-container">
        <h1 class="profile-header">Complete Your Profile</h1>
        <form class="profile-form" id="profileForm">
            <div class="profile-picture-container">
                <div class="profile-picture-preview" id="imagePreview">
                    <span>No image selected</span>
                </div>
                <div class="form-group">
                    <label for="profileImage">Profile Picture</label>
                    <input type="file" id="profileImage" name="profileImage" accept="image/*" class="upload-btn">
                </div>
            </div>
            <div class="form-group">
                <label for="username">Username <span class="required">*</span></label>
                <input type="text" id="username" name="username" placeholder="Enter your username" required>
                <small class="form-text text-muted">Usernames must be unique.</small>
            </div>
            <div class="form-group">
                <label for="fullName">Full Name</label>
                <input type="text" id="fullName" name="fullName" placeholder="Enter your full name">
            </div>
            <div class="form-group">
                <label for="age">Age <span class="optional">(Optional)</span></label>
                <input type="number" id="age" name="age" placeholder="Enter your age" min="18" max="120">
            </div>
            <div class="form-group">
                <label for="career">Career/Job Title <span class="optional">(Optional)</span></label>
                <input type="text" id="career" name="career" placeholder="Enter your job title or profession">
            </div>
            <div class="form-group">
                <label for="careerDescription">Career Description <span class="optional">(Optional)</span></label>
                <textarea id="careerDescription" name="careerDescription" placeholder="Tell us about your career (e.g., industry experience, goals)" rows="4"></textarea>
            </div>
            <button type="submit" class="submit-btn">Save Profile</button>
        </form>
    </div>
</main>
</body>
<script>
    function toggleDrawer() {
        const drawer = document.getElementById('sideDrawer');
        drawer.classList.toggle('collapsed');
    }
    function getThemePreference(name) {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        if (!match) return null;
        return match[2];
    }
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) window.location.reload();
    });
    window.addEventListener('DOMContentLoaded', () => {
        // Set theme
        const savedTheme = getThemePreference('theme');
        const body = document.body;
        if (savedTheme === 'light') {
            body.classList.add('light-mode');
        } else if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
        }
        if (savedTheme) {
            const input = document.querySelector(`input[name="theme"][value="${savedTheme}"]`);
            if (input) input.checked = true;
        }
        
        // Load user profile data
        loadProfileData();
    });
    
    function loadProfileData() {
        fetch('/api/profile')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch profile data');
                }
                return response.json();
            })
            .then(data => {
                // Check if the response has the expected structure with fields
                if (data && data.fields) {
                    // Populate username field
                    if (data.fields.username && data.fields.username.stringValue) {
                        document.getElementById('username').value = data.fields.username.stringValue;
                    }
                    
                    // Populate name field
                    if (data.fields.name && data.fields.name.stringValue) {
                        document.getElementById('fullName').value = data.fields.name.stringValue;
                    }
                    
                    // Populate age field
                    if (data.fields.age && data.fields.age.integerValue) {
                        document.getElementById('age').value = data.fields.age.integerValue;
                    }
                    
                    // Populate career field
                    if (data.fields.career && data.fields.career.stringValue) {
                        document.getElementById('career').value = data.fields.career.stringValue;
                    }
                    
                    // Populate career description field
                    if (data.fields.careerDescription && data.fields.careerDescription.stringValue) {
                        document.getElementById('careerDescription').value = data.fields.careerDescription.stringValue;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading profile data:', error);
            });
    }
    document.getElementById('profileImage').addEventListener('change', function(event) {
        const file = event.target.files[0];
        const preview = document.getElementById('imagePreview');

        if (file) {
            const reader = new FileReader();

            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="Profile Preview">`;
            }

            reader.readAsDataURL(file);
        } else {
            preview.innerHTML = '<span>No image selected</span>';
        }
    });

    document.getElementById('profileForm').addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Get form data
        const username = document.getElementById('username').value;
        const fullName = document.getElementById('fullName').value;
        const age = document.getElementById('age').value;
        const career = document.getElementById('career').value;
        const careerDescription = document.getElementById('careerDescription').value;
        
        // Validate username
        if (!username) {
            alert('Username is required.');
            return;
        }
        
        // Save profile data to Firebase
        fetch('/api/profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                name: fullName,
                age: age || null,
                career: career || '',
                careerDescription: careerDescription || ''
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json().then(data => {
                    alert('Profile saved successfully!');
                });
            } else if (response.status === 400) {
                // Handle username already taken error
                return response.json().then(data => {
                    if (data && data.message) {
                        alert(data.message);
                    } else {
                        alert('Failed to save profile. Please try again.');
                    }
                });
            } else {
                alert('Failed to save profile. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    });
</script>
</html>
