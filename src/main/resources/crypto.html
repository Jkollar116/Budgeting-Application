<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Wallet Manager</title>
    <link rel="stylesheet" href="style.css">
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }
        
        body {
            overflow-x: hidden;
            width: 100%;
        }
        /* Main Layout */
        .dashboard {
            display: grid;
            gap: 20px;
            padding: 20px;
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-areas:
                "portfolio portfolio market"
                "wallets wallets market"
                "walletlist walletlist analytics";
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* Cards */
        .card {
            background: #3E1F5B;
            border-radius: 12px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            margin-top: 0;
            color: #FF8C00;
            font-size: 1.5em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Portfolio Section */
        .portfolio-section {
            grid-area: portfolio;
            display: flex;
            flex-direction: column;
        }

        .portfolio-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .portfolio-chart {
            flex: 1;
            max-height: 220px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Stats */
        .stat {
            background: rgba(62, 31, 91, 0.7);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: transform 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .stat:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
            margin-bottom: 5px;
            display: block;
        }

        .stat-value {
            font-size: 1.6em;
            font-weight: bold;
            display: block;
        }

        /* Market Overview */
        .market-section {
            grid-area: market;
        }

        .market-card {
            background: rgba(62, 31, 91, 0.7);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .market-card h3 {
            color: #FF8C00;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .market-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .market-stat:last-child {
            border-bottom: none;
        }

        /* Wallet Management */
        .wallet-section {
            grid-area: wallets;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .add-wallet-form {
            background: rgba(62, 31, 91, 0.7);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .add-wallet-form h3 {
            color: #FF8C00;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .add-wallet-form input,
        .add-wallet-form select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #FF8C00;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.9);
            color: #222;
            font-size: 0.9em;
        }

        .test-buttons {
            background: rgba(62, 31, 91, 0.7);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .test-buttons h3 {
            color: #FF8C00;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Wallet List */
        .wallets-list-section {
            grid-area: walletlist;
        }

        .wallet-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .wallet-card {
            background: rgba(62, 31, 91, 0.7);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .wallet-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .wallet-header h3 {
            color: #FF8C00;
            margin: 0;
            font-size: 1.2em;
        }

        .wallet-type {
            background: #FF8C00;
            color: white;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .wallet-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .wallet-info-item {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .wallet-info-item .label {
            color: rgba(255, 255, 255, 0.7);
            display: block;
            margin-bottom: 3px;
        }

        .wallet-info-item .value {
            font-weight: bold;
        }

        .wallet-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Analytics Section */
        .analytics-section {
            grid-area: analytics;
        }

        .chart-container {
            height: 200px;
            margin-top: 15px;
            background: rgba(62, 31, 91, 0.7);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Buttons */
        .btn {
            background: #FF8C00;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.1s;
            font-weight: bold;
            font-size: 0.9em;
            text-align: center;
        }

        .btn:hover {
            background: #FFA500;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        /* Status Colors */
        .positive {
            color: #32CD32;
        }

        .negative {
            color: #FF4444;
        }

        /* QR Code Modal */
        .qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .qr-content {
            background: #3E1F5B;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 350px;
            width: 100%;
        }

        .qr-code img {
            margin: 20px auto;
            padding: 15px;
            background: white;
            border-radius: 5px;
            display: block;
        }

        /* Messages */
        .error-message {
            color: #ff4444;
            padding: 10px;
            margin: 10px 0;
            background: rgba(255,0,0,0.1);
            border-radius: 6px;
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
                grid-template-areas:
                    "portfolio market"
                    "wallets wallets"
                    "walletlist walletlist"
                    "analytics analytics";
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "portfolio"
                    "market"
                    "wallets"
                    "walletlist"
                    "analytics";
            }

            .wallet-section {
                grid-template-columns: 1fr;
            }

            .portfolio-stats {
                grid-template-columns: 1fr;
            }

            .wallet-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="crypto-page">
<header>
    <div class="logo">CashClimb</div>
    <nav>
        <ul class="nav-items">
            <li class="profile-link-container">
                <a href="profile.html">
                    <img id="navProfileImage" class="nav-profile-img" alt="Profile" />
                </a>
                <a href="profile.html" class="active">Profile</a>
            </li>
        </ul>
    </nav>
</header>
<button class="drawer-toggle" onclick="toggleDrawer()">☰</button>
<nav class="drawer" id="sideDrawer">
    <ul>
        <li><a href="home.html">Dashboard</a></li>
        <li><a href="assetsLiabilities.html" class="active">Assets &amp; Liabilities</a></li>
        <li><a href="bills.html">Bills Page</a></li>
        <li><a href="budget.html">Budget</a></li>
        <li><a href="chat.html">Chat</a></li>
        <li><a href="crypto.html">Crypto</a></li>
        <li><a href="currency.html">Currency</a></li>
        <li><a href="expenses.html">Expenses</a></li>
        <li><a href="income.html">Income</a></li>
        <li><a href="leaderboard.html">Leaderboard</a></li>
        <li><a href="loanCalculator.html">Loan Calculator</a></li>
        <!--        <li><a href="netWorth.html">Net Worth</a></li>-->
        <li><a href="tips.html">Tips</a></li>
        <li><a href="savedTips.html">Saved Tips</a></li>
        <li><a href="stocks.html">Stocks</a></li>
        <li><a href="tax.html">Tax</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="settings.html">Settings</a></li>
        <li><a href="/logout">Logout</a></li>
    </ul>
</nav>
<div class="dashboard">
    <!-- Portfolio Summary Section - More Compact -->
    <div class="card portfolio-section">
        <h2>Portfolio Summary</h2>
        <div class="portfolio-stats">
            <div class="stat">
                <span class="stat-label">Total Value</span>
                <span class="stat-value" id="total-value">$0.00</span>
            </div>
            <div class="stat">
                <span class="stat-label">24h Change</span>
                <span class="stat-value" id="total-change">0.00%</span>
            </div>
            <div class="stat">
                <span class="stat-label">Number of Wallets</span>
                <span class="stat-value" id="wallet-count">0</span>
            </div>
        </div>
        <div class="portfolio-chart">
            <canvas id="portfolio-chart"></canvas>
        </div>
    </div>

    <!-- Market Overview Section - Enhanced -->
    <div class="card market-section">
        <h2>Market Overview</h2>
        <div id="market-data">
            <!-- Market data will be inserted here via JavaScript -->
        </div>
    </div>

    <!-- Wallet Management Section - Side by Side -->
    <div class="card wallet-section">
        <div class="add-wallet-form">
            <h3>Add Custom Wallet</h3>
            <form id="custom-wallet-form">
                <input type="text" id="wallet-label" placeholder="Wallet Label" required>
                <input type="text" id="wallet-address" placeholder="Wallet Address" required>
                <select id="crypto-type" required>
                    <option value="">Select Cryptocurrency</option>
                    <option value="BTC">Bitcoin (BTC)</option>
                    <option value="ETH">Ethereum (ETH)</option>
                    <option value="USDT">Tether (USDT)</option>
                    <option value="BNB">Binance Coin (BNB)</option>
                    <option value="XRP">Ripple (XRP)</option>
                    <option value="ADA">Cardano (ADA)</option>
                    <option value="DOGE">Dogecoin (DOGE)</option>
                    <option value="SOL">Solana (SOL)</option>
                    <option value="DOT">Polkadot (DOT)</option>
                    <option value="AVAX">Avalanche (AVAX)</option>
                    <option value="MATIC">Polygon (MATIC)</option>
                    <option value="LINK">Chainlink (LINK)</option>
                </select>
                <button type="submit" class="btn">Add Wallet</button>
            </form>
        </div>
        <div class="test-buttons">
            <h3>Test Wallets</h3>
            <div class="btn-grid">
                <button id="add-btc-btn" class="btn">Add Test BTC</button>
                <button id="add-eth-btn" class="btn">Add Test ETH</button>
                <button id="refresh-all-btn" class="btn">Refresh All</button>
                <button id="clear-all-btn" class="btn">Clear All</button>
            </div>
        </div>
    </div>

    <!-- Wallet List Section - Bigger & More Prominent -->
    <div class="card wallets-list-section">
        <h2>Your Crypto Wallets</h2>
        <div id="error-container"></div>
        <div class="wallet-list" id="wallets-container">
            <!-- Wallet cards will be inserted here via JavaScript -->
        </div>
    </div>

    <!-- Analytics Section -->
    <div class="card analytics-section">
        <h2>Performance Analytics</h2>
        <select id="timeframe-selector">
            <option value="24h">24 Hours</option>
            <option value="7d">7 Days</option>
            <option value="30d">30 Days</option>
            <option value="1y">1 Year</option>
        </select>
        <div class="chart-container">
            <canvas id="performance-chart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="distribution-chart"></canvas>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

<script>
    function toggleDrawer() {
        const drawer = document.getElementById('sideDrawer');
        drawer.classList.toggle('collapsed');
    }
    function getThemePreference(name) {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        if (!match) return null;
        return match[2];
    }
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) window.location.reload();
    });
    window.addEventListener('DOMContentLoaded', () => {
        const savedTheme = getThemePreference('theme');
        const body = document.body;

        body.classList.remove('light-mode', 'dark-mode');
        if (savedTheme === 'light') {
            body.classList.add('light-mode');
        } else if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
        }
    });
    window.addEventListener("DOMContentLoaded", function () {
        fetch("/api/profile", {
            method: "GET",
            headers: { "Content-Type": "application/json" }
        })
            .then(res => res.json())
            .then(data => {
                const fields = data.fields || {};
                if (fields.profileImage) {
                    const base64Image = fields.profileImage.stringValue;
                    const navImg = document.getElementById("navProfileImage");
                    if (navImg) navImg.src = base64Image;
                }
            });
    });
    // Constants and Variables
    const TEST_WALLETS = {
        BTC: [
            { address: "1GrwDkr33gT6LuumniYjKEGjTLhsL5kmqC", label: "Bitcoin Wallet 1" },
            { address: "1F3bs9gGZcZHHnWQq1EtuqoVBLnTaD9k1A", label: "Bitcoin Wallet 2" }
        ],
        ETH: [
            { address: "0xde0b295669a9fd93d5f28d9ec85e40f4cb697bae", label: "Ethereum Foundation" },
            { address: "0x742d35Cc6634C0532925a3b844Bc454e4438f44e", label: "Ethereum Whale" }
        ]
    };

    let currentBTCIndex = 0;
    let currentETHIndex = 0;
    let portfolioChart = null;
    let performanceChart = null;
    let distributionChart = null;

    // Initialize when document loads
    document.addEventListener('DOMContentLoaded', function() {
        const btcButton = document.getElementById('add-btc-btn');
        const ethButton = document.getElementById('add-eth-btn');
        const refreshButton = document.getElementById('refresh-all-btn');
        const clearButton = document.getElementById('clear-all-btn');
        const customWalletForm = document.getElementById('custom-wallet-form');

        btcButton.addEventListener('click', addTestBitcoinWallet);
        ethButton.addEventListener('click', addTestEthereumWallet);
        refreshButton.addEventListener('click', refreshAllWallets);
        clearButton.addEventListener('click', clearAllWallets);

        customWalletForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const label = document.getElementById('wallet-label').value;
            const address = document.getElementById('wallet-address').value;
            const cryptoType = document.getElementById('crypto-type').value;

            addWallet(label, address, cryptoType);
            customWalletForm.reset();
        });

        // Initial loads
        loadWallets();
        loadMarketData();
        initializeAnalytics();
    });

    // Wallet Management Functions
    function addWallet(label, address, cryptoType) {
        console.log(`Adding wallet: ${label}, ${address}, ${cryptoType}`);

        // Create wallet with temporary placeholder data first
        const temporaryWallet = {
            id: Date.now().toString(), // Add unique ID for each wallet
            label: label,
            address: address,
            cryptoType: cryptoType,
            balance: 0,
            value: 0,
            change24h: 0,
            lastUpdated: new Date().toISOString()
        };

        let wallets = JSON.parse(localStorage.getItem('wallets') || '[]');

        // Check for duplicate address
        if (wallets.some(w => w.address === address)) {
            showError('Wallet with this address already exists');
            return;
        }

        // Add temporary wallet first so the UI updates immediately
        wallets.push(temporaryWallet);
        localStorage.setItem('wallets', JSON.stringify(wallets));
        loadWallets();
        
        showMessage(`Adding wallet ${label}, fetching real-time data...`);
        
        // Fetch real-time data for the new wallet
        const apiUrl = `/api/wallet?address=${encodeURIComponent(address)}&type=${encodeURIComponent(cryptoType)}`;
        
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Update wallet with real data from API
                let updatedWallets = JSON.parse(localStorage.getItem('wallets') || '[]');
                const walletIndex = updatedWallets.findIndex(w => w.id === temporaryWallet.id);
                
                if (walletIndex !== -1) {
                    // Update with real data
                    updatedWallets[walletIndex].balance = data.balance;
                    updatedWallets[walletIndex].value = data.value;
                    updatedWallets[walletIndex].change24h = data.priceChange24h || data.change24h;
                    updatedWallets[walletIndex].lastUpdated = new Date().toISOString();
                    
                    if (data.transactions && data.transactions.length > 0) {
                        updatedWallets[walletIndex].transactions = data.transactions;
                    }
                    
                    // Save updated wallets
                    localStorage.setItem('wallets', JSON.stringify(updatedWallets));
                    loadWallets();
                    
                    showMessage(`${cryptoType} wallet added with real-time data`);
                }
            })
            .catch(error => {
                console.error(`Error adding wallet with real-time data:`, error);
                showError(`Added wallet with placeholder data. Real-time data could not be fetched.`);
            });
    }

    function loadWallets() {
        const wallets = JSON.parse(localStorage.getItem('wallets') || '[]');
        updatePortfolioSummary(wallets);
        updateWalletsDisplay(wallets);
        updateAnalytics(wallets);
    }

    function updateWalletsDisplay(wallets) {
        const container = document.getElementById('wallets-container');
        container.innerHTML = '';

        if (wallets.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.7);">No wallets added. Add a wallet to get started.</div>';
            return;
        }

        wallets.forEach(wallet => {
            const card = createWalletCard(wallet);
            container.appendChild(card);
        });
    }

    function createWalletCard(wallet) {
        const div = document.createElement('div');
        div.className = 'wallet-card';

        const formattedValue = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(wallet.value);

        const formattedBalance = new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 8,
            maximumFractionDigits: 8
        }).format(wallet.balance);

        const changeClass = wallet.change24h >= 0 ? 'positive' : 'negative';

        div.innerHTML = `
            <div class="wallet-header">
                <h3>${wallet.label}</h3>
                <span class="wallet-type">${wallet.cryptoType}</span>
            </div>
            <div class="wallet-info">
                <div class="wallet-info-item">
                    <span class="label">Balance</span>
                    <span class="value">${formattedBalance} ${wallet.cryptoType}</span>
                </div>
                <div class="wallet-info-item">
                    <span class="label">Value</span>
                    <span class="value">${formattedValue}</span>
                </div>
                <div class="wallet-info-item">
                    <span class="label">Address</span>
                    <span class="value" style="font-size: 0.85em;">${formatAddress(wallet.address)}</span>
                </div>
                <div class="wallet-info-item">
                    <span class="label">24h Change</span>
                    <span class="value ${changeClass}">${wallet.change24h.toFixed(2)}%</span>
                </div>
            </div>
            <div class="wallet-actions">
                <button onclick="refreshWallet('${wallet.id}')" class="btn btn-small">Refresh</button>
                <button onclick="showQRCode('${wallet.address}')" class="btn btn-small">QR Code</button>
                <button onclick="deleteWallet('${wallet.id}')" class="btn btn-small">Delete</button>
            </div>
        `;
        return div;
    }

    function formatAddress(address) {
        if (!address) return '';
        if (address.length <= 15) return address;
        return address.substring(0, 8) + '...' + address.substring(address.length - 8);
    }

    function refreshWallet(id) {
        let wallets = JSON.parse(localStorage.getItem('wallets') || '[]');
        const wallet = wallets.find(w => w.id === id);
        
        if (!wallet) {
            showError("Wallet not found");
            return;
        }
        
        showMessage("Fetching real-time data...");
        
        // Create API URL to fetch wallet data from our backend
        const apiUrl = `/api/wallet?address=${encodeURIComponent(wallet.address)}&type=${encodeURIComponent(wallet.cryptoType)}`;
        
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Update wallet with real data from API
                wallet.balance = data.balance;
                wallet.value = data.value;
                wallet.change24h = data.change24h;
                wallet.lastUpdated = new Date().toISOString();
                
                if (data.transactions && data.transactions.length > 0) {
                    wallet.transactions = data.transactions;
                }
                
                // Save updated wallets
                wallets = wallets.map(w => w.id === id ? wallet : w);
                localStorage.setItem('wallets', JSON.stringify(wallets));
                loadWallets();
                
                showMessage("Wallet updated with real-time data");
            })
            .catch(error => {
                console.error("Error refreshing wallet:", error);
                
                // Fallback to simulated update if API fails
                const changePercent = (Math.random() * 4) - 2;
                wallet.value = wallet.value * (1 + (changePercent / 100));
                wallet.change24h = changePercent;
                wallet.lastUpdated = new Date().toISOString();
                
                wallets = wallets.map(w => w.id === id ? wallet : w);
                localStorage.setItem('wallets', JSON.stringify(wallets));
                loadWallets();
                
                showMessage("Wallet refreshed (using simulated data)");
            });
    }

    function deleteWallet(id) {
        if (!confirm('Are you sure you want to delete this wallet?')) return;

        let wallets = JSON.parse(localStorage.getItem('wallets') || '[]');
        const walletToDelete = wallets.find(w => w.id === id);
        wallets = wallets.filter(w => w.id !== id);
        localStorage.setItem('wallets', JSON.stringify(wallets));
        loadWallets();

        // Show a quick notification
        showMessage(`${walletToDelete.cryptoType} wallet deleted`);
    }

    // Portfolio Summary Functions
    function updatePortfolioSummary(wallets) {
        const totalValue = wallets.reduce((sum, wallet) => sum + (wallet.value || 0), 0);
        let avgChange = 0;

        if (wallets.length > 0) {
            // Weighted average change based on value
            avgChange = wallets.reduce((sum, wallet) => {
                return sum + (wallet.change24h || 0) * (wallet.value / totalValue);
            }, 0);
        }

        const totalValueElem = document.getElementById('total-value');
        const totalChangeElem = document.getElementById('total-change');
        const walletCountElem = document.getElementById('wallet-count');

        totalValueElem.textContent = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(totalValue);

        totalChangeElem.textContent = `${avgChange.toFixed(2)}%`;
        totalChangeElem.className = 'stat-value ' + (avgChange >= 0 ? 'positive' : 'negative');

        walletCountElem.textContent = wallets.length;

        updatePortfolioChart(wallets);
    }

    function updatePortfolioChart(wallets) {
        const ctx = document.getElementById('portfolio-chart').getContext('2d');

        if (portfolioChart) {
            portfolioChart.destroy();
        }

        if (wallets.length === 0) {
            ctx.font = '14px Arial';
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.textAlign = 'center';
            ctx.fillText('No wallet data to display', ctx.canvas.width/2, ctx.canvas.height/2);
            return;
        }

        portfolioChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: wallets.map(w => `${w.label} (${w.cryptoType})`),
                datasets: [{
                    data: wallets.map(w => w.value),
                    backgroundColor: [
                        '#FF8C00', '#1E90FF', '#32CD32', '#FF69B4', '#9370DB',
                        '#20B2AA', '#F08080', '#DEB887', '#87CEEB', '#DDA0DD'
                    ],
                    borderWidth: 2,
                    borderColor: '#3E1F5B'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false  // Hide legend to save space
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.formattedValue;
                                return `${label}: ${value}`;
                            }
                        }
                    }
                },
                cutout: '70%',
                radius: '90%'
            }
        });
    }

    // Helper Functions
    function showError(message) {
        const errorContainer = document.getElementById('error-container');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        errorContainer.appendChild(errorDiv);

        setTimeout(() => {
            errorDiv.style.opacity = '0';
            errorDiv.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                errorDiv.remove();
            }, 500);
        }, 4000);
    }

    function showMessage(message) {
        const msgDiv = document.createElement('div');
        msgDiv.style.position = 'fixed';
        msgDiv.style.top = '20px';
        msgDiv.style.right = '20px';
        msgDiv.style.backgroundColor = 'rgba(50, 205, 50, 0.9)';
        msgDiv.style.color = 'white';
        msgDiv.style.padding = '10px 20px';
        msgDiv.style.borderRadius = '5px';
        msgDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
        msgDiv.style.zIndex = '1000';
        msgDiv.textContent = message;

        document.body.appendChild(msgDiv);

        setTimeout(() => {
            msgDiv.style.opacity = '0';
            msgDiv.style.transition = 'opacity 0.5s ease';
            setTimeout(() => msgDiv.remove(), 500);
        }, 2000);
    }

    function clearAllWallets() {
        if (confirm('Are you sure you want to clear all wallets?')) {
            localStorage.removeItem('wallets');
            loadWallets();
            showMessage("All wallets were cleared");
        }
    }

    // Test Wallet Functions
    function addTestBitcoinWallet() {
        // Generate a different test wallet each time
        const wallet = TEST_WALLETS.BTC[currentBTCIndex % TEST_WALLETS.BTC.length];
        currentBTCIndex++;
        
        // Use the actual wallet address without modification
        // This ensures it's a valid address for the blockchain API
        addWallet(wallet.label + " " + currentBTCIndex, wallet.address, "BTC");
    }

    function addTestEthereumWallet() {
        // Generate a different test wallet each time
        const wallet = TEST_WALLETS.ETH[currentETHIndex % TEST_WALLETS.ETH.length];
        currentETHIndex++;
        
        // Use the actual wallet address without modification
        // This ensures it's a valid address for the blockchain API
        addWallet(wallet.label + " " + currentETHIndex, wallet.address, "ETH");
    }

    function refreshAllWallets() {
        let wallets = JSON.parse(localStorage.getItem('wallets') || '[]');

        if (wallets.length === 0) {
            showError("No wallets to refresh");
            return;
        }

        showMessage(`Refreshing ${wallets.length} wallets with real-time data...`);
        
        // Count how many wallets have been refreshed
        let refreshedCount = 0;
        let errorCount = 0;
        
        // Create a promise for each wallet refresh
        const refreshPromises = wallets.map(wallet => {
            // Create API URL for this wallet
            const apiUrl = `/api/wallet?address=${encodeURIComponent(wallet.address)}&type=${encodeURIComponent(wallet.cryptoType)}`;
            
            // Return a promise for this wallet refresh
            return fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Update wallet with real data from API
                    wallet.balance = data.balance;
                    wallet.value = data.value;
                    wallet.change24h = data.priceChange24h || data.change24h;
                    wallet.lastUpdated = new Date().toISOString();
                    
                    if (data.transactions && data.transactions.length > 0) {
                        wallet.transactions = data.transactions;
                    }
                    
                    refreshedCount++;
                    return wallet;
                })
                .catch(error => {
                    console.error(`Error refreshing wallet ${wallet.label}:`, error);
                    errorCount++;
                    return wallet; // Return wallet unmodified on error
                });
        });
        
        // Wait for all refresh operations to complete
        Promise.all(refreshPromises)
            .then(updatedWallets => {
                // Save all updated wallets
                localStorage.setItem('wallets', JSON.stringify(updatedWallets));
                loadWallets();
                
                // Show appropriate message based on refresh results
                if (errorCount === 0) {
                    showMessage(`Successfully refreshed all ${wallets.length} wallets with real-time data`);
                } else if (refreshedCount > 0) {
                    showMessage(`Refreshed ${refreshedCount} wallets, ${errorCount} failed`);
                } else {
                    showMessage(`Could not refresh any wallets with real-time data`);
                }
            });
    }

    // Market Data Implementation - Fetches real-time data from APIs
    function loadMarketData() {
        const marketDataDiv = document.getElementById('market-data');
        marketDataDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Loading real-time market data...</div>';

        // Create API URLs to fetch market data from our backend
        const btcApiUrl = `/api/wallet?type=BTC`;
        const ethApiUrl = `/api/wallet?type=ETH`;
        
        // Keep track of API call status
        let btcData, ethData;
        
        // Function to display market data once both crypto data points are available
        function displayMarketData() {
            if (btcData && ethData) {
                marketDataDiv.innerHTML = ''; // Clear loading message
                marketDataDiv.appendChild(createCryptoMarketCard('Bitcoin (BTC)', btcData));
                marketDataDiv.appendChild(createCryptoMarketCard('Ethereum (ETH)', ethData));
                createTrendChart();
                
                // Add a last updated timestamp
                const updateInfo = document.createElement('div');
                updateInfo.className = 'market-card';
                updateInfo.innerHTML = `
                    <div style="font-size: 0.8em; text-align: center; padding: 5px;">
                        <i>Last updated: ${new Date().toLocaleTimeString()}</i>
                        <button id="refresh-market-btn" class="btn btn-small" style="margin-left: 10px;">↻ Refresh</button>
                    </div>
                `;
                marketDataDiv.appendChild(updateInfo);
                
                // Add refresh button event listener
                document.getElementById('refresh-market-btn').addEventListener('click', function() {
                    this.textContent = "Refreshing...";
                    this.disabled = true;
                    loadMarketData();
                });
            }
        }
        
        // Function to fetch data with retry capability
        function fetchWithRetry(url, maxRetries = 3) {
            let retryCount = 0;
            
            function tryFetch() {
                return fetch(url, { timeout: 10000 }) // Add timeout to prevent long hanging requests
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`API call failed: ${response.status}`);
                        }
                        return response.json();
                    })
                    .catch(error => {
                        console.error(`Error fetching data (attempt ${retryCount + 1}):`, error);
                        if (retryCount < maxRetries) {
                            retryCount++;
                            // Exponential backoff retry
                            const backoff = Math.min(1000 * Math.pow(2, retryCount), 10000);
                            console.log(`Retrying in ${backoff}ms...`);
                            return new Promise(resolve => setTimeout(() => resolve(tryFetch()), backoff));
                        }
                        throw error;
                    });
            }
            
            return tryFetch();
        }
        
        // Fetch BTC market data
        fetchWithRetry(btcApiUrl, 3)
            .then(data => {
                btcData = data;
                displayMarketData();
            })
            .catch(() => {
                // If all retries failed, show error UI
                const errorCard = document.createElement('div');
                errorCard.className = 'market-card';
                errorCard.innerHTML = `
                    <h3>Bitcoin (BTC)</h3>
                    <div style="text-align:center; padding:10px; color:#ff4444;">
                        Unable to fetch real-time data.<br>
                        <button id="retry-btc-btn" class="btn btn-small" style="margin-top:10px;">Retry</button>
                    </div>
                `;
                marketDataDiv.innerHTML = ''; // Clear loading if this is first response
                marketDataDiv.appendChild(errorCard);
                
                document.getElementById('retry-btc-btn').addEventListener('click', function() {
                    this.textContent = "Retrying...";
                    this.disabled = true;
                    fetchWithRetry(btcApiUrl, 3)
                        .then(data => {
                            btcData = data;
                            displayMarketData();
                        })
                        .catch(e => {
                            console.error("Retry failed:", e);
                        });
                });
            });
        
        // Fetch ETH market data
        fetchWithRetry(ethApiUrl, 3)
            .then(data => {
                ethData = data;
                displayMarketData();
            })
            .catch(() => {
                // If all retries failed, show error UI
                if (marketDataDiv.innerHTML.includes('Loading')) {
                    marketDataDiv.innerHTML = '';
                }
                
                const errorCard = document.createElement('div');
                errorCard.className = 'market-card';
                errorCard.innerHTML = `
                    <h3>Ethereum (ETH)</h3>
                    <div style="text-align:center; padding:10px; color:#ff4444;">
                        Unable to fetch real-time data.<br>
                        <button id="retry-eth-btn" class="btn btn-small" style="margin-top:10px;">Retry</button>
                    </div>
                `;
                marketDataDiv.appendChild(errorCard);
                
                document.getElementById('retry-eth-btn').addEventListener('click', function() {
                    this.textContent = "Retrying...";
                    this.disabled = true;
                    fetchWithRetry(ethApiUrl, 3)
                        .then(data => {
                            ethData = data;
                            displayMarketData();
                        })
                        .catch(e => {
                            console.error("Retry failed:", e);
                        });
                });
            });
    }
    
    // Helper function to create a crypto market card with real-time data
    function createCryptoMarketCard(name, data) {
        const card = document.createElement('div');
        card.className = 'market-card';
        
        // Extract market data from API response
        const price = data.currentPrice;
        const change24h = data.priceChange24h;
        const marketCap = data.marketCap;
        const volume24h = data.volume24h;
        
        // Add a subtle animation to draw attention to the card
        card.style.animation = 'fadeIn 0.5s ease-in';
        
        card.innerHTML = `
            <h3>${name}</h3>
            <div class="market-stat">
                <span>Price</span>
                <span>${formatCurrency(price)}</span>
            </div>
            <div class="market-stat">
                <span>24h Change</span>
                <span class="${change24h >= 0 ? 'positive' : 'negative'}">${change24h.toFixed(2)}%</span>
            </div>
            <div class="market-stat">
                <span>Market Cap</span>
                <span>${formatLargeNumber(marketCap)}</span>
            </div>
            <div class="market-stat">
                <span>24h Volume</span>
                <span>${formatLargeNumber(volume24h)}</span>
            </div>
        `;
        
        return card;
    }

    // Function to create trend chart with real-time data
    function createTrendChart() {
        try {
            // Create chart container
            const marketDataDiv = document.getElementById('market-data');
            const trendContainer = document.createElement('div');
            trendContainer.style.marginTop = '15px';
            trendContainer.style.height = '120px';
            trendContainer.innerHTML = '<canvas id="trend-chart"></canvas>';
            marketDataDiv.appendChild(trendContainer);
    
            // Extract prices from DOM
            let btcPrice = 0;
            let ethPrice = 0;
            
            try {
                const btcCard = marketDataDiv.querySelector('.market-card:first-child');
                const ethCard = marketDataDiv.querySelector('.market-card:nth-child(2)');
                
                if (btcCard && ethCard) {
                    const btcPriceText = btcCard.querySelector('.market-stat:first-child span:last-child').textContent;
                    const ethPriceText = ethCard.querySelector('.market-stat:first-child span:last-child').textContent;
                    
                    // Extract numeric value from currency string (e.g. "$65,432.10" -> 65432.10)
                    btcPrice = parseFloat(btcPriceText.replace(/[^0-9.]/g, ''));
                    ethPrice = parseFloat(ethPriceText.replace(/[^0-9.]/g, ''));
                }
            } catch (e) {
                console.warn("Could not extract prices from DOM:", e);
                // If we can't extract prices, don't show the chart
                return;
            }
            
            // If we couldn't get prices, don't show chart
            if (!btcPrice || !ethPrice || btcPrice === 0 || ethPrice === 0) {
                console.warn("Invalid price data, cannot create chart");
                return;
            }
            
            // Instead of generating mock trend data, show just the current prices
            // as a simple comparison chart
            const trendCtx = document.getElementById('trend-chart').getContext('2d');
            new Chart(trendCtx, {
                type: 'bar',
                data: {
                    labels: ['Current Prices (USD)'],
                    datasets: [
                        {
                            label: 'BTC',
                            data: [btcPrice],
                            backgroundColor: 'rgba(255, 140, 0, 0.7)',
                            borderColor: '#FF8C00',
                            borderWidth: 1
                        },
                        {
                            label: 'ETH',
                            data: [ethPrice],
                            backgroundColor: 'rgba(30, 144, 255, 0.7)',
                            borderColor: '#1E90FF',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                },
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: 'white',
                                boxWidth: 15,
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.raw.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Error creating price comparison chart:", error);
            
            // Add error recovery
            const marketDataDiv = document.getElementById('market-data');
            const errorNotice = document.createElement('div');
            errorNotice.className = 'market-card';
            errorNotice.innerHTML = `
                <div style="text-align: center; padding: 10px;">
                    <p>Price chart unavailable</p>
                    <button id="retry-chart-btn" class="btn btn-small">Retry</button>
                </div>
            `;
            marketDataDiv.appendChild(errorNotice);
            
            // Add retry button functionality
            document.getElementById('retry-chart-btn').addEventListener('click', function() {
                this.textContent = 'Retrying...';
                setTimeout(() => {
                    try {
                        // Remove error message
                        errorNotice.remove();
                        // Try to create chart again
                        createTrendChart();
                    } catch (e) {
                        console.error("Retry failed:", e);
                    }
                }, 500);
            });
        }
    }

    // Analytics Implementation
    function initializeAnalytics() {
        document.getElementById('timeframe-selector').addEventListener('change', updateAnalytics);
        updateAnalytics();
    }

    function updateAnalytics() {
        const wallets = JSON.parse(localStorage.getItem('wallets') || '[]');
        updatePerformanceChart(wallets);
        updateDistributionChart(wallets);
    }

    function updatePerformanceChart(wallets) {
        const ctx = document.getElementById('performance-chart').getContext('2d');

        if (performanceChart) {
            performanceChart.destroy();
        }

        if (wallets.length === 0) {
            ctx.font = '14px Arial';
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.textAlign = 'center';
            ctx.fillText('No wallet data to display', ctx.canvas.width/2, ctx.canvas.height/2);
            return;
        }
        
        // We don't have historical data available yet, so display info message
        const totalValue = wallets.reduce((sum, wallet) => sum + wallet.value, 0);
        
        ctx.font = '14px Arial';
        ctx.fillStyle = 'rgba(255,255,255,0.7)';
        ctx.textAlign = 'center';
        ctx.fillText('Historical data not available - Only current data is shown', ctx.canvas.width/2, ctx.canvas.height/2);
        
        // Instead of generating mock data, just show the current value
        const timeframe = document.getElementById('timeframe-selector').value;
        const labels = [timeframe === '24h' ? 'Current' : 
                       timeframe === '7d' ? 'This Week' : 
                       timeframe === '30d' ? 'This Month' : 'This Year'];
        
        const values = [totalValue];

        performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Portfolio Value',
                    data: values,
                    borderColor: '#FF8C00',
                    backgroundColor: 'rgba(255, 140, 0, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Value: ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            },
                            color: 'rgba(255, 255, 255, 0.7)'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        }
                    },
                    x: {
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.7)',
                            maxRotation: 45,
                            minRotation: 45,
                            font: {
                                size: 10
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    function updateDistributionChart(wallets) {
        const ctx = document.getElementById('distribution-chart').getContext('2d');

        if (distributionChart) {
            distributionChart.destroy();
        }

        if (wallets.length === 0) {
            ctx.font = '14px Arial';
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.textAlign = 'center';
            ctx.fillText('No wallet data to display', ctx.canvas.width/2, ctx.canvas.height/2);
            return;
        }

        // Group by crypto type
        const btcValue = wallets.filter(w => w.cryptoType === 'BTC').reduce((sum, w) => sum + w.value, 0);
        const ethValue = wallets.filter(w => w.cryptoType === 'ETH').reduce((sum, w) => sum + w.value, 0);

        const totalValue = btcValue + ethValue;
        const btcPercent = totalValue > 0 ? ((btcValue / totalValue) * 100).toFixed(1) : 0;
        const ethPercent = totalValue > 0 ? ((ethValue / totalValue) * 100).toFixed(1) : 0;

        distributionChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: [`BTC (${btcPercent}%)`, `ETH (${ethPercent}%)`],
                datasets: [{
                    data: [btcValue, ethValue],
                    backgroundColor: ['#FF8C00', '#1E90FF'],
                    borderWidth: 2,
                    borderColor: '#3E1F5B'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#fff',
                            font: {
                                size: 12
                            },
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${formatCurrency(context.raw)}`;
                            }
                        }
                    }
                }
            }
        });
    }

    // QR Code Implementation with real-time uniqueness verification
    function showQRCode(address) {
        console.log("Generating QR code for address:", address);
        
        // Generate a truly unique QR code with multiple uniqueness factors
        // 1. Address
        // 2. Current timestamp (milliseconds)
        // 3. Random nonce
        const uniqueNonce = Math.random().toString(36).substring(2, 15);
        const uniqueData = `${address}?timestamp=${Date.now()}&nonce=${uniqueNonce}`;
        console.log("Generated unique QR data with nonce:", uniqueNonce);
        
        // Use a higher error correction level for better scanning
        const qr = qrcode(0, 'H');
        qr.addData(uniqueData);
        qr.make();
        
        // Create timestamp to display generation time
        const timestamp = new Date().toISOString();
        
        // Create modal with unique ID based on timestamp and nonce
        const modalId = `qr-modal-${Date.now()}-${uniqueNonce}`;
        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'qr-modal';

        // Create content with unique data and verification info
        modal.innerHTML = `
            <div class="qr-content">
                <h3>Wallet QR Code</h3>
                <div class="qr-code">${qr.createImgTag(5)}</div>
                <p style="word-break: break-all; font-size: 0.9em; margin-bottom: 15px;">${address}</p>
                <p style="font-size: 0.7em; color: rgba(255,255,255,0.5);">Generated: ${timestamp}</p>
                <p style="font-size: 0.7em; color: rgba(255,255,255,0.5);">Unique ID: ${Date.now().toString(36)}</p>
                <button class="btn">Close</button>
            </div>
        `;

        // Add click event to close modal
        modal.querySelector('button').addEventListener('click', () => {
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.3s ease';
            setTimeout(() => modal.remove(), 300);
        });

        // Add modal to the page
        document.body.appendChild(modal);

        // Close when clicking outside content
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s ease';
                setTimeout(() => modal.remove(), 300);
            }
        });
    }

    // Utility Functions
    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }

    function formatLargeNumber(value) {
        if (value >= 1e12) return (value / 1e12).toFixed(2) + 'T';
        if (value >= 1e9) return (value / 1e9).toFixed(2) + 'B';
        if (value >= 1e6) return (value / 1e6).toFixed(2) + 'M';
        return value.toLocaleString();
    }
</script>

</body>
</html>
