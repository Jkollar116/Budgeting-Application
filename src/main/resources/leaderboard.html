<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Leaderboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .leaderboard-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .leaderboard-table {
            width: 100%;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .leaderboard-table-header {
            background-color: var(--dark-bg);
        }
        
        .leaderboard-table th {
            text-align: left;
            padding: 15px;
            color: var(--text-color);
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
        }
        
        .leaderboard-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .leaderboard-table tr:last-child td {
            border-bottom: none;
        }
        
        .leaderboard-table tr:hover {
            background-color: var(--dark-hover);
        }
        
        .leaderboard-table tr.current-user {
            background-color: rgba(255, 140, 0, 0.1);
        }
        
        .leaderboard-table tr.current-user:hover {
            background-color: rgba(255, 140, 0, 0.2);
        }
        
        .rank {
            width: 60px;
            text-align: center;
            font-weight: bold;
        }
        
        .rank-1, .rank-2, .rank-3 {
            font-size: 1.2em;
        }
        
        .rank-1 {
            color: gold;
        }
        
        .rank-2 {
            color: silver;
        }
        
        .rank-3 {
            color: #cd7f32; /* bronze */
        }
        
        .username {
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
        }
        
        .username:hover {
            text-decoration: underline;
        }
        
        .net-worth {
            text-align: right;
            font-weight: bold;
            width: 150px;
        }
        
        .loading-container {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        
        .pagination-button {
            background-color: var(--dark-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .pagination-button:hover {
            background-color: var(--dark-hover);
        }
        
        .pagination-button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .pagination-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .your-rank {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .your-rank-title {
            margin: 0;
            color: var(--text-color);
            flex-grow: 1;
        }
        
        .your-rank-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-color);
            padding: 0 15px;
        }
        
        .your-rank-label {
            color: var(--text-muted);
            font-size: 0.9em;
        }
        
        .recalculate-button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .recalculate-button:hover {
            background-color: var(--accent-hover);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: var(--card-bg);
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
        }
        
        .close-modal:hover {
            color: var(--text-color);
        }
        
        .user-profile {
            text-align: center;
            padding: 20px 0;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--dark-bg);
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: var(--accent-color);
        }
        
        .user-name {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0 0 5px;
            color: var(--primary-color);
        }
        
        .user-username {
            color: var(--text-muted);
            margin: 0 0 15px;
        }
        
        .user-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .user-stat {
            text-align: center;
        }
        
        .user-stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .user-stat-label {
            color: var(--text-muted);
            font-size: 0.9em;
        }
        
        .user-details {
            padding: 20px 0;
            border-top: 1px solid var(--border-color);
        }
        
        .user-detail {
            margin-bottom: 15px;
        }
        
        .user-detail-label {
            color: var(--text-muted);
            font-size: 0.9em;
        }
        
        .user-detail-value {
            color: var(--text-color);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 0;
            color: var(--text-muted);
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .leaderboard-table th, .leaderboard-table td {
                padding: 8px;
            }
            
            .your-rank {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .your-rank-title {
                margin-bottom: 10px;
            }
            
            .your-rank-value {
                padding: 0;
            }
            
            .rank {
                width: 40px;
            }
            
            .net-worth {
                width: 100px;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="logo">CashClimb</div>
    <nav>
        <ul>
            <li><a href="home.html">Dashboard</a></li>
            <li><a href="leaderboard.html" class="active">Leaderboard</a></li>
            <li><a href="profile.html">Profile</a></li>
        </ul>
    </nav>
</header>
<button class="drawer-toggle" onclick="toggleDrawer()">â˜°</button>
<nav class="drawer" id="sideDrawer">
    <ul>
        <li><a href="home.html">Dashboard</a></li>
        <li><a href="expenses.html">Expenses</a></li>
        <li><a href="income.html">Income</a></li>
        <li><a href="tax.html">Tax</a></li>
        <li><a href="crypto.html">Crypto</a></li>
        <li><a href="stocks.html">Stocks</a></li>
        <li><a href="chat.html">Chat</a></li>
        <li><a href="tips.html">Tips</a></li>
        <li><a href="savedTips.html">Saved Tips</a></li>
        <li><a href="savingsTips.html">Savings Tips</a></li>
        <li><a href="assetsLiabilities.html">Assets &amp; Liabilities</a></li>
        <li><a href="budget.html">Budget</a></li>
        <li><a href="bills.html">Bills</a></li>
        <li><a href="alerts.html">Alerts</a></li>
        <li><a href="leaderboard.html" class="active">Leaderboard</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="settings.html">Settings</a></li>
        <li><a href="/logout">Logout</a></li>
    </ul>
</nav>

<main>
    <div class="hero">
        <div class="header-content">
            <h1>Leaderboard</h1>
            <p>See how your financial progress compares to other users</p>
        </div>
    </div>
    
    <div class="leaderboard-container">
        <div class="your-rank" id="yourRank">
            <h2 class="your-rank-title">Your Current Rank</h2>
            <div class="your-rank-value">Loading...</div>
            <div class="your-rank-label">out of <span id="totalUsers">0</span> users</div>
            <button class="recalculate-button" id="recalculateButton">Recalculate Net Worth</button>
        </div>
        
        <div id="leaderboardContainer">
            <div class="loading-container">
                <p>Loading leaderboard data...</p>
            </div>
        </div>
        
        <div class="pagination" id="pagination">
            <!-- Pagination will be added here dynamically -->
        </div>
    </div>
    
    <!-- User Details Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <div id="userModalContent">
                <!-- User details will be loaded here -->
            </div>
        </div>
    </div>
</main>

<script>
    // Global variables
    let leaderboardData = [];
    let currentPage = 1;
    const itemsPerPage = 20;
    
    // Initial setup
    function toggleDrawer() {
        const drawer = document.getElementById('sideDrawer');
        drawer.classList.toggle('collapsed');
    }
    
    function getThemePreference(name) {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return match ? match[2] : null;
    }
    
    window.addEventListener('DOMContentLoaded', () => {
        const body = document.body;
        const theme = getThemePreference('theme');
        if (theme === 'light') body.classList.add('light-mode');
        else if (theme === 'dark') body.classList.add('dark-mode');
        
        // Fetch your rank and leaderboard data
        fetchUserRank();
        fetchLeaderboard();
        
        // Set up event listeners
        document.getElementById('recalculateButton').addEventListener('click', recalculateNetWorth);
        document.getElementById('closeModal').addEventListener('click', closeUserModal);
    });
    
    // Fetch user's current rank
    function fetchUserRank() {
        fetch('/api/leaderboard/rank')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch user rank');
                }
                return response.json();
            })
            .then(data => {
                document.querySelector('.your-rank-value').textContent = `#${data.rank}`;
            })
            .catch(error => {
                console.error('Error fetching user rank:', error);
                document.querySelector('.your-rank-value').textContent = 'Unknown';
            });
    }
    
    // Fetch leaderboard data
    function fetchLeaderboard() {
        fetch('/api/leaderboard')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch leaderboard');
                }
                return response.json();
            })
            .then(data => {
                leaderboardData = data.users;
                document.getElementById('totalUsers').textContent = data.totalUsers;
                
                renderLeaderboard();
                renderPagination();
            })
            .catch(error => {
                console.error('Error fetching leaderboard:', error);
                document.getElementById('leaderboardContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>Error Loading Leaderboard</h3>
                        <p>There was a problem loading the leaderboard data. Please try again later.</p>
                    </div>
                `;
            });
    }
    
    // Render leaderboard table
    function renderLeaderboard() {
        const leaderboardContainer = document.getElementById('leaderboardContainer');
        
        if (leaderboardData.length === 0) {
            leaderboardContainer.innerHTML = `
                <div class="empty-state">
                    <h3>No Users Found</h3>
                    <p>There are no users on the leaderboard yet.</p>
                </div>
            `;
            return;
        }
        
        // Calculate start and end index for pagination
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, leaderboardData.length);
        const paginatedData = leaderboardData.slice(startIndex, endIndex);
        
        // Create table HTML
        let tableHtml = `
            <table class="leaderboard-table">
                <thead class="leaderboard-table-header">
                    <tr>
                        <th class="rank">Rank</th>
                        <th>User</th>
                        <th class="net-worth">Net Worth</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        paginatedData.forEach(user => {
            const isCurrentUser = user.isCurrentUser;
            const rankClass = user.rank <= 3 ? `rank-${user.rank}` : '';
            
            tableHtml += `
                <tr class="${isCurrentUser ? 'current-user' : ''}">
                    <td class="rank ${rankClass}">${user.rank}</td>
                    <td>
                        <span class="username" onclick="showUserDetails('${user.id}')">${user.username}</span>
                        ${user.name ? `<span class="user-name"> (${user.name})</span>` : ''}
                    </td>
                    <td class="net-worth">$${formatNumber(user.netWorth)}</td>
                </tr>
            `;
        });
        
        tableHtml += `
                </tbody>
            </table>
        `;
        
        leaderboardContainer.innerHTML = tableHtml;
    }
    
    // Render pagination controls
    function renderPagination() {
        const paginationContainer = document.getElementById('pagination');
        const totalPages = Math.ceil(leaderboardData.length / itemsPerPage);
        
        if (totalPages <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }
        
        let paginationHtml = '';
        
        // Add previous button
        paginationHtml += `
            <button class="pagination-button ${currentPage === 1 ? 'disabled' : ''}" 
                ${currentPage === 1 ? 'disabled' : 'onclick="changePage(' + (currentPage - 1) + ')"'}>
                &lt; Prev
            </button>
        `;
        
        // Add page buttons
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHtml += `
                <button class="pagination-button ${i === currentPage ? 'active' : ''}" 
                    onclick="changePage(${i})">
                    ${i}
                </button>
            `;
        }
        
        // Add next button
        paginationHtml += `
            <button class="pagination-button ${currentPage === totalPages ? 'disabled' : ''}" 
                ${currentPage === totalPages ? 'disabled' : 'onclick="changePage(' + (currentPage + 1) + ')"'}>
                Next &gt;
            </button>
        `;
        
        paginationContainer.innerHTML = paginationHtml;
        paginationContainer.style.display = 'flex';
    }
    
    // Change pagination page
    function changePage(page) {
        currentPage = page;
        renderLeaderboard();
        renderPagination();
        
        // Scroll to top of leaderboard
        document.getElementById('leaderboardContainer').scrollIntoView({ behavior: 'smooth' });
    }
    
    // Recalculate user's net worth
    function recalculateNetWorth() {
        const button = document.getElementById('recalculateButton');
        button.textContent = 'Recalculating...';
        button.disabled = true;
        
        fetch('/api/netWorth/recalculate', {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to recalculate net worth');
            }
            return response.json();
        })
        .then(data => {
            // Update UI with new net worth
            alert(`Net worth successfully recalculated: $${formatNumber(data.netWorth)}`);
            
            // Refresh leaderboard and rank
            fetchUserRank();
            fetchLeaderboard();
        })
        .catch(error => {
            console.error('Error recalculating net worth:', error);
            alert('Failed to recalculate net worth. Please try again later.');
        })
        .finally(() => {
            button.textContent = 'Recalculate Net Worth';
            button.disabled = false;
        });
    }
    
    // Show user details modal
    function showUserDetails(userId) {
        const modal = document.getElementById('userModal');
        const modalContent = document.getElementById('userModalContent');
        
        modalContent.innerHTML = '<div class="loading-container">Loading user details...</div>';
        modal.style.display = 'block';
        
        fetch(`/api/leaderboard/user/${userId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch user details');
                }
                return response.json();
            })
            .then(user => {
                // Get first letter of username for avatar
                const firstLetter = user.username.charAt(0).toUpperCase();
                
                let userHtml = `
                    <div class="user-profile">
                        <div class="user-avatar">${firstLetter}</div>
                        <h2 class="user-name">${user.name || user.username}</h2>
                        <p class="user-username">@${user.username}</p>
                        
                        <div class="user-stats">
                            <div class="user-stat">
                                <div class="user-stat-value">#${user.rank}</div>
                                <div class="user-stat-label">Rank</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-value">$${formatNumber(user.netWorth)}</div>
                                <div class="user-stat-label">Net Worth</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-details">
                `;
                
                // Add optional details if available
                if (user.career) {
                    userHtml += `
                        <div class="user-detail">
                            <div class="user-detail-label">Career</div>
                            <div class="user-detail-value">${user.career}</div>
                        </div>
                    `;
                }
                
                if (user.careerDescription) {
                    userHtml += `
                        <div class="user-detail">
                            <div class="user-detail-label">Career Description</div>
                            <div class="user-detail-value">${user.careerDescription}</div>
                        </div>
                    `;
                }
                
                if (user.age) {
                    userHtml += `
                        <div class="user-detail">
                            <div class="user-detail-label">Age</div>
                            <div class="user-detail-value">${user.age}</div>
                        </div>
                    `;
                }
                
                userHtml += `</div>`;
                
                modalContent.innerHTML = userHtml;
            })
            .catch(error => {
                console.error('Error fetching user details:', error);
                modalContent.innerHTML = `
                    <div class="empty-state">
                        <h3>Error Loading User</h3>
                        <p>There was a problem loading the user details. Please try again later.</p>
                    </div>
                `;
            });
    }
    
    // Close user details modal
    function closeUserModal() {
        document.getElementById('userModal').style.display = 'none';
    }
    
    // Close modal when clicking outside of it
    window.onclick = function(event) {
        const modal = document.getElementById('userModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };
    
    // Format number with commas for thousands separator
    function formatNumber(num) {
        return new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(num);
    }
</script>
</body>
</html>
